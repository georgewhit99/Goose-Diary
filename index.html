<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goose's Diary ü™ø - Daily Diary</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,300;0,400;0,600;0,700;1,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #fdfbf7;
            --color-surface: #ffffff;
            --color-text: #2d2320;
            --color-text-secondary: #6b5d57;
            --color-primary: #d4845c;
            --color-primary-dark: #b86d47;
            --color-accent: #e8b298;
            --color-border: #e8ddd4;
            --color-shadow: rgba(45, 35, 32, 0.08);

            --mood-anxious: #8b7fa8;
            --mood-happy: #f6c85f;
            --mood-motivated: #6eb5a0;
            --mood-tired: #9eb3c8;
            --mood-grateful: #e89e6f;
            --mood-overwhelmed: #c4918b;
            --mood-peaceful: #a8c5b9;
            --mood-excited: #f19c79;
            --mood-joyful: #ffd166;
            --mood-proud: #d4a574;
            --mood-energetic: #f4a261;
            --mood-calm: #b8d4cc;
            --mood-hopeful: #a8c5e0;
            --mood-loved: #e5a3b4;
            --mood-content: #c8b8a8;
            --mood-exhausted: #9da3ad;
            --mood-stressed: #b58a8a;
            --mood-frustrated: #c49090;
            --mood-sad: #9eb5c8;
            --mood-worried: #a89fb8;
            --mood-confused: #b5a8a8;
            --mood-restless: #b8a8a3;
            --mood-inspired: #c5b5e0;
            --mood-period: #c94c4c;
        }

        .dark {
            --color-bg: #1a1614;
            --color-surface: #2d2320;
            --color-text: #f5ede6;
            --color-text-secondary: #b8a99f;
            --color-primary: #e89e6f;
            --color-primary-dark: #d4845c;
            --color-accent: #6b5d57;
            --color-border: #3d332e;
            --color-shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0;
            min-height: 100vh;
            background: var(--color-bg);
        }

        /* Header */
        .app-header {
            background: var(--color-surface);
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(253, 251, 247, 0.95);
        }

        .dark .app-header {
            background: rgba(26, 22, 20, 0.95);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .app-title {
            font-family: 'Fraunces', serif;
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-size: 1.25rem;
        }

        .icon-btn:hover {
            background: var(--color-border);
            color: var(--color-text);
        }

        .icon-btn.active {
            background: var(--color-primary);
            color: white;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
            color: var(--color-text-secondary);
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .nav-tab.active {
            background: var(--color-primary);
            color: white;
        }

        /* Main Content */
        .view-container {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Daily Entry View */
        .daily-view {
            padding: 1.5rem;
        }

        /* Streak Calendar */
        .streak-calendar {
            background: linear-gradient(135deg, #94a3b8, #cbd5e1);
            border-radius: 1.25rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px var(--color-shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .streak-calendar.active-streak {
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
        }

        .streak-calendar.active-streak::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translate(0, 0); opacity: 0; }
            50% { transform: translate(10%, 10%); opacity: 1; }
        }

        .streak-calendar.milestone {
            animation: celebrateMilestone 0.6s ease-out;
        }

        @keyframes celebrateMilestone {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.02) rotate(-1deg); }
            75% { transform: scale(1.02) rotate(1deg); }
        }

        .streak-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .streak-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            transition: all 0.3s ease;
        }

        .streak-info.hidden {
            opacity: 0.4;
        }

        .streak-number {
            font-family: 'Fraunces', serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 2.5rem;
            text-align: center;
        }

        .streak-number.growing {
            animation: growNumber 0.5s ease-out;
        }

        @keyframes growNumber {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .streak-label {
            font-size: 0.85rem;
            opacity: 0.9;
            transition: all 0.3s ease;
        }

        .streak-progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.6);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        .week-nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .week-nav-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .week-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .date-picker-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-picker-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .week-indicator {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.75rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .week-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .week-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .week-day-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            letter-spacing: 0.5px;
        }

        .week-day-dot {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
        }

        .week-day-dot:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
        }

        .week-day-dot.completed {
            background: white;
            border-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 0 0 rgba(255, 255, 255, 0.6);
            animation: completePulse 0.6s ease-out;
        }

        @keyframes completePulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 0 8px rgba(255, 255, 255, 0.3); }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        .week-day-dot.completed::after {
            content: '‚úì';
            color: var(--color-primary);
            font-weight: 700;
            font-size: 1.1rem;
            animation: checkAppear 0.4s ease-out 0.2s both;
        }

        @keyframes checkAppear {
            0% { transform: scale(0) rotate(-45deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .week-day-dot.completed:hover::after {
            animation: none;
        }

        .week-day-dot.today {
            border-width: 3px;
            border-color: white;
            animation: todayPulse 2s ease-in-out infinite;
        }

        @keyframes todayPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(255, 255, 255, 0); }
        }

        .week-day-dot.today:not(.completed) {
            background: rgba(255, 255, 255, 0.4);
        }

        .week-day-number {
            font-size: 0.75rem;
            color: var(--color-primary);
            font-weight: 600;
        }

        .date-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .current-date {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            color: var(--color-text);
            margin-bottom: 0.25rem;
        }

        .current-day {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        /* Mood Rating */
        .section-card {
            background: var(--color-surface);
            border-radius: 1.25rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px var(--color-shadow);
            position: relative;
        }

        .section-title {
            font-family: 'Fraunces', serif;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        .mood-rating {
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
        }

        .rating-label {
            text-align: center;
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .mood-number {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            border: 2px solid var(--color-border);
            background: var(--color-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Fraunces', serif;
            color: var(--color-text-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .mood-number:hover {
            transform: scale(1.1);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .mood-number.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
            transform: scale(1.15);
        }

        .mood-number.active::after {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: 2px solid var(--color-primary);
            opacity: 0.3;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.1);
                opacity: 0;
            }
        }

        /* Text Input Areas */
        .input-group {
            margin-bottom: 1rem;
        }

        .input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .input-label {
            font-weight: 500;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .input-actions {
            display: flex;
            gap: 0.5rem;
        }

        .small-icon-btn {
            background: var(--color-border);
            border: none;
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--color-text-secondary);
        }

        .small-icon-btn:hover {
            background: var(--color-primary);
            color: white;
        }

        .small-icon-btn.recording {
            background: #ef4444;
            color: white;
            animation: recordPulse 1.5s ease-in-out infinite;
        }

        @keyframes recordPulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            background: var(--color-bg);
            color: var(--color-text);
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
            transition: all 0.2s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(212, 132, 92, 0.1);
        }

        .photo-upload-area {
            margin-top: 0.75rem;
        }

        .photo-preview {
            display: none;
            margin-top: 0.75rem;
            position: relative;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .photo-preview.has-photo {
            display: block;
        }

        .photo-preview img {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: cover;
            border-radius: 0.75rem;
        }

        .remove-photo {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mood Tags */
        .mood-categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.4rem;
        }

        .mood-category {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .mood-category-header {
            font-family: 'Fraunces', serif;
            font-size: 0.65rem;
            font-weight: 600;
            text-align: center;
            padding: 0.25rem 0.4rem;
            border-radius: 0.5rem;
            letter-spacing: 0.02em;
        }

        .mood-category.positive .mood-category-header {
            background: linear-gradient(135deg, rgba(246, 200, 95, 0.2), rgba(107, 181, 160, 0.2));
            color: var(--mood-happy);
        }

        .dark .mood-category.positive .mood-category-header {
            background: linear-gradient(135deg, rgba(246, 200, 95, 0.15), rgba(107, 181, 160, 0.15));
        }

        .mood-category.neutral .mood-category-header {
            background: linear-gradient(135deg, rgba(168, 197, 185, 0.25), rgba(168, 197, 224, 0.25));
            color: var(--mood-calm);
        }

        .dark .mood-category.neutral .mood-category-header {
            background: linear-gradient(135deg, rgba(168, 197, 185, 0.15), rgba(168, 197, 224, 0.15));
        }

        .mood-category.negative .mood-category-header {
            background: linear-gradient(135deg, rgba(196, 145, 139, 0.2), rgba(139, 127, 168, 0.2));
            color: var(--mood-stressed);
        }

        .dark .mood-category.negative .mood-category-header {
            background: linear-gradient(135deg, rgba(196, 145, 139, 0.15), rgba(139, 127, 168, 0.15));
        }

        .mood-tags {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .mood-tag {
            padding: 0.35rem 0.4rem;
            border-radius: 1rem;
            border: 2px solid var(--color-border);
            background: var(--color-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.7rem;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mood-tag:hover {
            transform: translateY(-1px);
        }

        .mood-tag.active {
            border-color: currentColor;
            transform: translateY(-1px);
        }

        /* Larger screens: more breathing room */
        @media (min-width: 400px) {
            .mood-categories {
                gap: 0.6rem;
            }

            .mood-category {
                gap: 0.4rem;
            }

            .mood-category-header {
                font-size: 0.75rem;
                padding: 0.35rem 0.5rem;
            }

            .mood-tags {
                gap: 0.35rem;
            }

            .mood-tag {
                padding: 0.45rem 0.5rem;
                font-size: 0.78rem;
            }
        }

        @media (min-width: 500px) {
            .mood-categories {
                gap: 1rem;
            }

            .mood-category {
                gap: 0.5rem;
            }

            .mood-category-header {
                font-size: 0.8rem;
                padding: 0.4rem 0.6rem;
            }

            .mood-tags {
                gap: 0.4rem;
            }

            .mood-tag {
                padding: 0.5rem 0.6rem;
                font-size: 0.85rem;
            }
        }

        .mood-tag[data-mood="anxious"] { color: var(--mood-anxious); }
        .mood-tag[data-mood="anxious"].active { background: var(--mood-anxious); color: white; }

        .mood-tag[data-mood="happy"] { color: var(--mood-happy); }
        .mood-tag[data-mood="happy"].active { background: var(--mood-happy); color: var(--color-text); }

        .mood-tag[data-mood="motivated"] { color: var(--mood-motivated); }
        .mood-tag[data-mood="motivated"].active { background: var(--mood-motivated); color: white; }

        .mood-tag[data-mood="tired"] { color: var(--mood-tired); }
        .mood-tag[data-mood="tired"].active { background: var(--mood-tired); color: white; }

        .mood-tag[data-mood="grateful"] { color: var(--mood-grateful); }
        .mood-tag[data-mood="grateful"].active { background: var(--mood-grateful); color: white; }

        .mood-tag[data-mood="overwhelmed"] { color: var(--mood-overwhelmed); }
        .mood-tag[data-mood="overwhelmed"].active { background: var(--mood-overwhelmed); color: white; }

        .mood-tag[data-mood="peaceful"] { color: var(--mood-peaceful); }
        .mood-tag[data-mood="peaceful"].active { background: var(--mood-peaceful); color: white; }

        .mood-tag[data-mood="excited"] { color: var(--mood-excited); }
        .mood-tag[data-mood="excited"].active { background: var(--mood-excited); color: white; }

        .mood-tag[data-mood="joyful"] { color: var(--mood-joyful); }
        .mood-tag[data-mood="joyful"].active { background: var(--mood-joyful); color: var(--color-text); }

        .mood-tag[data-mood="proud"] { color: var(--mood-proud); }
        .mood-tag[data-mood="proud"].active { background: var(--mood-proud); color: white; }

        .mood-tag[data-mood="energetic"] { color: var(--mood-energetic); }
        .mood-tag[data-mood="energetic"].active { background: var(--mood-energetic); color: white; }

        .mood-tag[data-mood="calm"] { color: var(--mood-calm); }
        .mood-tag[data-mood="calm"].active { background: var(--mood-calm); color: white; }

        .mood-tag[data-mood="hopeful"] { color: var(--mood-hopeful); }
        .mood-tag[data-mood="hopeful"].active { background: var(--mood-hopeful); color: white; }

        .mood-tag[data-mood="loved"] { color: var(--mood-loved); }
        .mood-tag[data-mood="loved"].active { background: var(--mood-loved); color: white; }

        .mood-tag[data-mood="content"] { color: var(--mood-content); }
        .mood-tag[data-mood="content"].active { background: var(--mood-content); color: white; }

        .mood-tag[data-mood="exhausted"] { color: var(--mood-exhausted); }
        .mood-tag[data-mood="exhausted"].active { background: var(--mood-exhausted); color: white; }

        .mood-tag[data-mood="stressed"] { color: var(--mood-stressed); }
        .mood-tag[data-mood="stressed"].active { background: var(--mood-stressed); color: white; }

        .mood-tag[data-mood="frustrated"] { color: var(--mood-frustrated); }
        .mood-tag[data-mood="frustrated"].active { background: var(--mood-frustrated); color: white; }

        .mood-tag[data-mood="sad"] { color: var(--mood-sad); }
        .mood-tag[data-mood="sad"].active { background: var(--mood-sad); color: white; }

        .mood-tag[data-mood="worried"] { color: var(--mood-worried); }
        .mood-tag[data-mood="worried"].active { background: var(--mood-worried); color: white; }

        .mood-tag[data-mood="confused"] { color: var(--mood-confused); }
        .mood-tag[data-mood="confused"].active { background: var(--mood-confused); color: white; }

        .mood-tag[data-mood="restless"] { color: var(--mood-restless); }
        .mood-tag[data-mood="restless"].active { background: var(--mood-restless); color: white; }

        .mood-tag[data-mood="inspired"] { color: var(--mood-inspired); }
        .mood-tag[data-mood="inspired"].active { background: var(--mood-inspired); color: white; }

        .mood-tag[data-mood="period"] { color: var(--mood-period); }
        .mood-tag[data-mood="period"].active { background: var(--mood-period); color: white; }

        /* Daily Prompt */
        .daily-prompt {
            margin-top: 1rem;
        }

        .prompt-question {
            font-family: 'Fraunces', serif;
            font-style: italic;
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--color-primary);
            padding: 1rem;
            background: var(--color-bg);
            border-radius: 0.75rem;
            border-left: 3px solid var(--color-primary);
        }

        /* Save Button */
        .save-btn-container {
            position: relative;
            margin-top: 1rem;
        }

        .save-btn {
            width: 100%;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 1rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .save-btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 132, 92, 0.3);
        }

        .save-btn:active {
            transform: translateY(0);
        }

        .save-message {
            position: absolute;
            top: -3.5rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--mood-peaceful);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            animation: slideUp 0.3s ease;
            pointer-events: none;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Celebration Animation */
        .celebration-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .save-btn.celebrating {
            animation: celebrationPulse 0.6s ease;
        }

        @keyframes celebrationPulse {
            0%, 100% {
                transform: scale(1);
            }
            25% {
                transform: scale(1.1) rotate(-5deg);
            }
            50% {
                transform: scale(1.15) rotate(5deg);
            }
            75% {
                transform: scale(1.1) rotate(-3deg);
            }
        }

        /* Timeline View */
        .timeline-view {
            padding: 1.5rem;
        }

        .flashback-card {
            background: linear-gradient(135deg, var(--mood-peaceful), var(--mood-grateful));
            color: white;
            padding: 1.5rem;
            border-radius: 1.25rem;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flashback-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(168, 197, 185, 0.3);
        }

        .flashback-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .flashback-date {
            font-family: 'Fraunces', serif;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .flashback-text {
            font-style: italic;
            line-height: 1.5;
        }

        .moment-card {
            background: var(--color-surface);
            border-radius: 1.25rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px var(--color-shadow);
            border-left: 4px solid var(--color-primary);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .moment-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px var(--color-shadow);
        }

        .moment-card::after {
            content: '‚úèÔ∏è Edit';
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 0.85rem;
            color: var(--color-primary);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .moment-card:hover::after {
            opacity: 1;
        }

        .moment-date {
            font-family: 'Fraunces', serif;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--color-primary);
        }

        .moment-rating {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .moment-text {
            color: var(--color-text);
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        .moment-moods {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .moment-mood-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .moment-photo {
            margin-top: 1rem;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .moment-photo img {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: cover;
        }

        /* Weekly Dashboard */
        .dashboard-card {
            background: var(--color-surface);
            border-radius: 1.25rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px var(--color-shadow);
        }

        .dashboard-title {
            font-family: 'Fraunces', serif;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--color-bg);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .stat-value {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            color: var(--color-primary);
            font-weight: 600;
        }

        .word-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            padding: 1rem;
            background: var(--color-bg);
            border-radius: 0.75rem;
        }

        .word-cloud-item {
            padding: 0.5rem 1rem;
            background: var(--color-primary);
            color: white;
            border-radius: 1.5rem;
            font-weight: 500;
            opacity: 0.9;
            transition: all 0.2s ease;
        }

        .word-cloud-item:hover {
            transform: scale(1.1);
            opacity: 1;
        }

        /* Mood Balance */
        .mood-balance-bars {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .mood-balance-bar {
            flex: 1;
            text-align: center;
        }

        .mood-balance-label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mood-balance-visual {
            height: 120px;
            background: var(--color-bg);
            border-radius: 0.75rem;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .mood-balance-fill {
            width: 100%;
            transition: height 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
            font-family: 'Fraunces', serif;
            position: relative;
            min-height: 30px;
        }

        .mood-balance-fill::before {
            content: attr(data-count);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .mood-balance-fill.positive {
            background: linear-gradient(135deg, #6eb5a0, #f6c85f);
        }

        .mood-balance-fill.negative {
            background: linear-gradient(135deg, #9eb3c8, #c4918b);
        }

        .mood-balance-emoji {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .mood-sentiment-message {
            text-align: center;
            padding: 1rem;
            background: var(--color-bg);
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-style: italic;
            color: var(--color-text-secondary);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            padding: 1rem;
            background: var(--color-bg);
            border-radius: 0.75rem;
        }

        .photo-grid-item {
            aspect-ratio: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .photo-grid-item:hover {
            transform: scale(1.05);
        }

        .photo-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Monthly Dashboard */
        .month-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--color-surface);
            border-radius: 1rem;
        }

        .month-btn {
            background: var(--color-border);
            border: none;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--color-text);
        }

        .month-btn:hover {
            background: var(--color-primary);
            color: white;
        }

        .current-month {
            font-family: 'Fraunces', serif;
            font-size: 1.25rem;
            color: var(--color-text);
        }

        .mood-chart {
            padding: 1rem;
            background: var(--color-bg);
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            gap: 0.25rem;
        }

        .chart-bar {
            flex: 1;
            background: var(--color-primary);
            border-radius: 0.25rem 0.25rem 0 0;
            min-height: 4px;
            transition: all 0.3s ease;
            position: relative;
        }

        .chart-bar:hover {
            background: var(--color-primary-dark);
        }

        .chart-bar::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.25rem;
        }

        .chart-labels {
            display: flex;
            justify-content: space-around;
            margin-top: 0.5rem;
        }

        .chart-label {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            text-align: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: 1.25rem;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUpModal 0.3s ease;
        }

        @keyframes slideUpModal {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            color: var(--color-text);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-secondary);
            cursor: pointer;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            background: var(--color-border);
        }

        .success-message {
            background: var(--mood-peaceful);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            margin-bottom: 1rem;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
            border: 2px solid var(--color-border);
            background: var(--color-bg);
            color: var(--color-text);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            border-color: var(--color-primary);
        }

        .filter-btn.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        input[type="file"], input[type="date"] {
            display: none;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .photo-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-secondary);
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }

        /* Achievements */
        .achievements-btn {
            position: relative;
        }

        .achievement-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: linear-gradient(135deg, #f6c85f, #e89e6f);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--color-surface);
            animation: pulse 2s ease-in-out infinite;
        }

        .achievements-categories {
            margin-top: 1.5rem;
        }

        .achievement-category {
            margin-bottom: 2rem;
        }

        .achievement-category-title {
            font-family: 'Fraunces', serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .achievement-category-count {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            font-weight: 500;
            background: var(--color-border);
            padding: 0.15rem 0.5rem;
            border-radius: 1rem;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .achievement-card {
            background: var(--color-bg);
            border-radius: 1rem;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--color-border);
            position: relative;
            overflow: hidden;
        }

        .achievement-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .achievement-card.unlocked {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, rgba(232, 158, 111, 0.15), rgba(107, 168, 160, 0.15));
            box-shadow: 0 4px 12px rgba(232, 158, 111, 0.2);
            animation: unlockPulse 0.6s ease-out;
        }

        .achievement-card.unlocked::before {
            transform: scaleX(1);
        }

        @keyframes unlockPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .achievement-card.in-progress {
            border-color: rgba(232, 158, 111, 0.4);
            background: linear-gradient(135deg, rgba(232, 158, 111, 0.05), rgba(107, 168, 160, 0.05));
        }

        .achievement-card.in-progress:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .achievement-card.locked {
            display: none;
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: block;
            transition: transform 0.3s ease;
        }

        .achievement-card.unlocked .achievement-icon {
            animation: iconCelebrate 0.6s ease-out 0.2s;
        }

        @keyframes iconCelebrate {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-10deg) scale(1.1); }
            75% { transform: rotate(10deg) scale(1.1); }
        }

        .achievement-name {
            font-family: 'Fraunces', serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 0.25rem;
        }

        .achievement-desc {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        .achievement-progress-container {
            margin-top: 0.75rem;
        }

        .achievement-progress-text {
            font-size: 0.7rem;
            color: var(--color-primary);
            font-weight: 600;
            margin-bottom: 0.35rem;
        }

        .achievement-progress-bar-mini {
            height: 4px;
            background: var(--color-border);
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }

        .achievement-progress-fill-mini {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            border-radius: 1rem;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .achievement-progress-fill-mini::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmerProgress 2s infinite;
        }

        @keyframes shimmerProgress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .achievement-notification {
            position: fixed;
            top: 6rem;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            color: white;
            padding: 1.25rem 1.75rem;
            border-radius: 1.25rem;
            box-shadow: 0 8px 24px rgba(212, 132, 92, 0.4);
            z-index: 2000;
            text-align: center;
            min-width: 280px;
            animation: achievementSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes achievementSlideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-50px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
        }

        .achievement-notification-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            display: block;
            animation: bounce 0.6s ease-in-out 0.3s;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .achievement-notification-title {
            font-family: 'Fraunces', serif;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            opacity: 0.9;
        }

        .achievement-notification-name {
            font-family: 'Fraunces', serif;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .achievement-notification-desc {
            font-size: 0.85rem;
            opacity: 0.95;
        }

        .achievements-summary {
            background: linear-gradient(135deg, rgba(232, 158, 111, 0.1), rgba(107, 168, 160, 0.1));
            padding: 1.25rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
            border: 2px solid var(--color-border);
            position: relative;
            overflow: hidden;
        }

        .achievements-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: summaryShine 3s infinite;
        }

        @keyframes summaryShine {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        .achievements-progress-bar {
            height: 10px;
            background: var(--color-border);
            border-radius: 1rem;
            overflow: hidden;
            margin: 0.75rem 0;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .achievements-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 0 10px rgba(232, 158, 111, 0.5);
        }

        .achievements-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShimmer 2s infinite;
        }

        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .achievements-stats {
            font-size: 0.9rem;
            color: var(--color-text);
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .achievements-stats strong {
            color: var(--color-primary);
            font-size: 1.1rem;
        }

        /* Animated Goose */
        .animated-goose-container {
            position: fixed;
            top: 80px;
            left: -100px;
            z-index: 9999;
            pointer-events: none;
            animation: gooseWalk 8s ease-in-out forwards;
        }

        .goose {
            font-size: 3rem;
            animation: gooseBob 0.5s ease-in-out infinite;
        }

        .speech-bubble {
            position: absolute;
            top: -40px;
            left: 60px;
            background: white;
            color: #2d2320;
            padding: 0.75rem 1.25rem;
            border-radius: 1.25rem;
            font-weight: 700;
            font-size: 1.25rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            animation: honkAppear 2s ease-in-out 3s forwards;
            white-space: nowrap;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid white;
        }

        @keyframes gooseWalk {
            1000% {
                left: -100px;
            }
            60% {
                left: 50%;
                transform: translateX(-50%);
            }
            40% {
                left: 50%;
                transform: translateX(-50%);
            }
            0% {
                left: calc(100% + 100px);
            }
        }

        @keyframes gooseBob {
            0%, 100% {
                transform: translateY(0) rotate(-5deg);
            }
            50% {
                transform: translateY(-5px) rotate(5deg);
            }
        }

        @keyframes honkAppear {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            20% {
                opacity: 1;
                transform: scale(1.2);
            }
            40% {
                transform: scale(1);
            }
            80% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        .dark .speech-bubble {
            background: var(--color-surface);
            color: var(--color-text);
        }

        .dark .speech-bubble::after {
            border-top-color: var(--color-surface);
        }

        /* Dark mode streak calendar */
        .dark .streak-calendar {
            background: linear-gradient(135deg, #3d332e, #2d2320);
        }

        .dark .streak-calendar.active-streak {
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
        }

        /* Dark mode achievements */
        .dark .achievement-card.unlocked {
            background: linear-gradient(135deg, rgba(232, 158, 111, 0.2), rgba(107, 168, 160, 0.2));
            box-shadow: 0 4px 12px rgba(232, 158, 111, 0.3);
        }

        .dark .achievement-card.in-progress {
            background: linear-gradient(135deg, rgba(232, 158, 111, 0.08), rgba(107, 168, 160, 0.08));
        }

        .dark .achievements-summary {
            background: linear-gradient(135deg, rgba(232, 158, 111, 0.15), rgba(107, 168, 160, 0.15));
            border-color: var(--color-border);
        }
    </style>
</head>
<body>
    <!-- Animated Goose -->
    <div class="animated-goose-container" id="animatedGoose">
        <div class="goose">ü™ø</div>
        <div class="speech-bubble">HONK!</div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-top">
                <h1 class="app-title">Goose's Diary ü™ø</h1>
                <div class="header-actions">
                    <button class="icon-btn achievements-btn" id="achievementsBtn" title="Achievements">
                        üèÜ
                        <span class="achievement-badge" id="achievementBadge" style="display: none;">0</span>
                    </button>
                    <button class="icon-btn" id="darkModeToggle" title="Toggle dark mode">üåô</button>
                </div>
            </div>
            <nav class="nav-tabs">
                <button class="nav-tab active" data-view="daily">Today</button>
                <button class="nav-tab" data-view="timeline">Timeline</button>
                <button class="nav-tab" data-view="weekly">Week</button>
                <button class="nav-tab" data-view="monthly">Month</button>
            </nav>
        </header>

        <!-- Daily Entry View -->
        <div class="view-container active" id="daily-view">
            <div class="daily-view">
                <!-- Streak Calendar -->
                <div class="streak-calendar" id="streakCalendar">
                    <div class="streak-progress-bar" id="streakProgressBar"></div>
                    <div class="streak-header">
                        <div class="streak-info" id="streakInfo">
                            <div class="streak-number" id="streakCount">0</div>
                            <div class="streak-label" id="streakLabel">
                                <div style="font-weight: 600;">Day Streak üî•</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;" id="streakMessage">Start your journey!</div>
                            </div>
                        </div>
                        <button class="week-nav-btn" id="prevWeek" title="Previous week">‚óÄ</button>
                        <button class="week-nav-btn" id="nextWeek" title="Next week">‚ñ∂</button>
                    </div>
                    <div class="week-indicator" id="weekIndicator">This Week</div>
                    <div class="week-days" id="weekDays">
                        <!-- Days will be populated by JavaScript -->
                    </div>
                </div>

                <div class="date-header">
                    <div class="current-date" id="currentDate"></div>
                    <div class="current-day" id="currentDay"></div>
                    <div id="editingBadge" style="display: none; margin-top: 0.5rem;">
                        <span style="background: var(--color-primary); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem;">
                            ‚úèÔ∏è Editing
                        </span>
                        <button id="cancelEdit" style="background: var(--color-border); border: none; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem; margin-left: 0.5rem; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Mood Rating -->
                <div class="section-card">
                    <h2 class="section-title">Rate your day</h2>
                    <div class="rating-label">1 (Tough) ‚Üí 5 (Amazing)</div>
                    <div class="mood-rating" id="moodRating">
                        <button class="mood-number" data-rating="1">1</button>
                        <button class="mood-number" data-rating="2">2</button>
                        <button class="mood-number" data-rating="3">3</button>
                        <button class="mood-number" data-rating="4">4</button>
                        <button class="mood-number" data-rating="5">5</button>
                    </div>
                </div>

                <!-- Moment with Kids -->
                <div class="section-card">
                    <h2 class="section-title">Moment with the Kids</h2>
                    <div class="input-group">
                        <div class="input-header">
                            <span class="input-label">Share a special moment</span>
                            <div class="input-actions">
                                <button class="small-icon-btn" id="kidsVoiceBtn" title="Voice input">üé§</button>
                                <label class="small-icon-btn" for="kidsPhoto" title="Add photo">üì∑</label>
                                <input type="file" id="kidsPhoto" accept="image/*">
                            </div>
                        </div>
                        <textarea id="kidsText" placeholder="What made this moment special?"></textarea>
                        <div class="photo-preview" id="kidsPhotoPreview">
                            <img id="kidsPhotoImg" alt="Kids moment">
                            <button class="remove-photo" id="removeKidsPhoto">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Moment for Yourself -->
                <div class="section-card">
                    <h2 class="section-title">Moment for Yourself</h2>
                    <div class="input-group">
                        <div class="input-header">
                            <span class="input-label">A moment just for you</span>
                            <div class="input-actions">
                                <button class="small-icon-btn" id="selfVoiceBtn" title="Voice input">üé§</button>
                                <label class="small-icon-btn" for="selfPhoto" title="Add photo">üì∑</label>
                                <input type="file" id="selfPhoto" accept="image/*">
                            </div>
                        </div>
                        <textarea id="selfText" placeholder="How did you take care of yourself today?"></textarea>
                        <div class="photo-preview" id="selfPhotoPreview">
                            <img id="selfPhotoImg" alt="Self care moment">
                            <button class="remove-photo" id="removeSelfPhoto">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Daily Prompt -->
                <div class="section-card">
                    <h2 class="section-title">Daily Reflection</h2>
                    <div class="daily-prompt" id="dailyPrompt">
                        <div class="prompt-question" id="promptQuestion"></div>
                        <div class="input-group">
                            <div class="input-header">
                                <span class="input-label">Your thoughts</span>
                                <div class="input-actions">
                                    <button class="small-icon-btn" id="promptVoiceBtn" title="Voice input">üé§</button>
                                </div>
                            </div>
                            <textarea id="promptAnswer" placeholder="Write your answer here..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Mood Tags -->
                <div class="section-card">
                    <h2 class="section-title">Today I felt...</h2>
                    <div class="mood-categories" id="moodTags">
                        <!-- Positive Moods -->
                        <div class="mood-category positive">
                            <div class="mood-category-header">Positive</div>
                            <div class="mood-tags">
                                <button class="mood-tag" data-mood="happy">üòä Happy</button>
                                <button class="mood-tag" data-mood="joyful">üåü Joyful</button>
                                <button class="mood-tag" data-mood="grateful">üôè Grateful</button>
                                <button class="mood-tag" data-mood="proud">üèÜ Proud</button>
                                <button class="mood-tag" data-mood="motivated">üí™ Motivated</button>
                                <button class="mood-tag" data-mood="energetic">‚ö° Energetic</button>
                                <button class="mood-tag" data-mood="excited">üéâ Excited</button>
                                <button class="mood-tag" data-mood="loved">üíï Loved</button>
                            </div>
                        </div>
                        <!-- Neutral Moods -->
                        <div class="mood-category neutral">
                            <div class="mood-category-header">Neutral</div>
                            <div class="mood-tags">
                                <button class="mood-tag" data-mood="peaceful">üòå Peaceful</button>
                                <button class="mood-tag" data-mood="period">ü©∏ Period</button>
                                <button class="mood-tag" data-mood="calm">üßò Calm</button>
                                <button class="mood-tag" data-mood="hopeful">üåà Hopeful</button>
                                <button class="mood-tag" data-mood="content">‚ò∫Ô∏è Content</button>
                                <button class="mood-tag" data-mood="tired">üò¥ Tired</button>
                                <button class="mood-tag" data-mood="inspired">‚ú® Inspired</button>
                                <button class="mood-tag" data-mood="confused">üòï Confused</button>
                                
                            </div>
                        </div>
                        <!-- Negative Moods -->
                        <div class="mood-category negative">
                            <div class="mood-category-header">Negative</div>
                            <div class="mood-tags">
                                <button class="mood-tag" data-mood="exhausted">üò´ Exhausted</button>
                                <button class="mood-tag" data-mood="anxious">üò∞ Anxious</button>
                                <button class="mood-tag" data-mood="stressed">üò£ Stressed</button>
                                <button class="mood-tag" data-mood="overwhelmed">üòì Overwhelmed</button>
                                <button class="mood-tag" data-mood="frustrated">üò§ Frustrated</button>
                                <button class="mood-tag" data-mood="sad">üò¢ Sad</button>
                                <button class="mood-tag" data-mood="worried">üòü Worried</button>
                                <button class="mood-tag" data-mood="restless">üò¨ Restless</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="save-btn-container">
                    <button class="save-btn" id="saveEntry">Save Entry</button>
                </div>
            </div>
        </div>

        <!-- Timeline View -->
        <div class="view-container" id="timeline-view">
            <div class="timeline-view">
                <div id="flashbackContainer"></div>

                <div class="filter-buttons" id="timelineFilters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="week">This Week</button>
                    <button class="filter-btn" data-filter="month">This Month</button>
                </div>

                <div id="timelineEntries"></div>
            </div>
        </div>

        <!-- Weekly Dashboard -->
        <div class="view-container" id="weekly-view">
            <div class="daily-view">
                <div class="dashboard-card">
                    <h2 class="dashboard-title">This Week's Summary</h2>
                    <div class="stat-row">
                        <span class="stat-label">Average Mood</span>
                        <span class="stat-value" id="weeklyAvgMood">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Entries This Week</span>
                        <span class="stat-value" id="weeklyEntryCount">0</span>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h2 class="dashboard-title">Mood Balance</h2>
                    <div id="weeklyMoodBalance"></div>
                    <div class="word-cloud" id="weeklyWordCloud"></div>
                </div>

                <div class="dashboard-card">
                    <h2 class="dashboard-title">This Week's Photos</h2>
                    <div class="photo-grid" id="weeklyPhotos"></div>
                </div>
            </div>
        </div>

        <!-- Monthly Dashboard -->
        <div class="view-container" id="monthly-view">
            <div class="daily-view">
                <div class="month-selector">
                    <button class="month-btn" id="prevMonth">‚Üê</button>
                    <div class="current-month" id="currentMonth"></div>
                    <button class="month-btn" id="nextMonth">‚Üí</button>
                </div>

                <div class="dashboard-card">
                    <h2 class="dashboard-title">Monthly Mood Trend</h2>
                    <div class="mood-chart">
                        <div class="chart-bars" id="monthlyMoodChart"></div>
                        <div class="chart-labels" id="monthlyMoodLabels"></div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h2 class="dashboard-title">Monthly Statistics</h2>
                    <div class="stat-row">
                        <span class="stat-label">Average Mood</span>
                        <span class="stat-value" id="monthlyAvgMood">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Entries</span>
                        <span class="stat-value" id="monthlyEntryCount">0</span>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h2 class="dashboard-title">Mood Balance</h2>
                    <div id="monthlyMoodBalance"></div>
                    <div class="word-cloud" id="monthlyWordCloud"></div>
                </div>

                <div class="dashboard-card">
                    <h2 class="dashboard-title">Monthly Photos</h2>
                    <div class="photo-grid" id="monthlyPhotos"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="modal" id="photoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Photo</h3>
                <button class="close-modal" id="closePhotoModal">‚úï</button>
            </div>
            <img id="modalPhoto" style="width: 100%; border-radius: 0.75rem;" alt="Full size photo">
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal" id="achievementsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üèÜ Achievements</h3>
                <button class="close-modal" id="closeAchievementsModal">‚úï</button>
            </div>
            <div class="achievements-summary">
                <div class="achievements-stats">
                    <strong id="unlockedCount">0</strong> of <strong id="totalCount">0</strong> unlocked
                </div>
                <div class="achievements-progress-bar">
                    <div class="achievements-progress-fill" id="achievementsProgressFill" style="width: 0%"></div>
                </div>
            </div>
            <div class="achievements-categories" id="achievementsCategories"></div>
        </div>
    </div>

     <script>
        // App State
        let currentRating = 0;
        let selectedMoods = [];
        let kidsPhotoData = null;
        let selfPhotoData = null;
        let currentView = 'daily';
        let currentMonthOffset = 0;
        let weekOffset = 0;
        let recognition = null;
        let currentVoiceInput = null;
        let db = null;
        let editingDate = null;

        // Mood categorization
        const positiveMoods = ['happy', 'joyful', 'grateful', 'proud', 'motivated', 'energetic', 'peaceful', 'calm', 'excited', 'hopeful', 'loved', 'content', 'inspired'];
        const negativeMoods = ['tired', 'exhausted', 'anxious', 'stressed', 'overwhelmed', 'frustrated', 'sad', 'lonely', 'worried', 'confused', 'restless'];

        // Achievements definition
        const achievements = [
            // Entry milestones
            { id: 'first_entry', name: 'First Steps', desc: 'Create your first diary entry', icon: 'üìù', category: 'entries', check: (stats) => stats.totalEntries >= 1 },
            { id: 'five_entries', name: 'Getting Started', desc: 'Create 5 diary entries', icon: '‚úçÔ∏è', category: 'entries', check: (stats) => stats.totalEntries >= 5 },
            { id: 'ten_entries', name: 'Dedicated Diarist', desc: 'Create 10 diary entries', icon: 'üìñ', category: 'entries', check: (stats) => stats.totalEntries >= 10 },
            { id: 'twentyfive_entries', name: 'Storyteller', desc: 'Create 25 diary entries', icon: 'üìö', category: 'entries', check: (stats) => stats.totalEntries >= 25 },
            { id: 'fifty_entries', name: 'Memory Keeper', desc: 'Create 50 diary entries', icon: 'üéØ', category: 'entries', check: (stats) => stats.totalEntries >= 50 },
            { id: 'hundred_entries', name: 'Century Club', desc: 'Create 100 diary entries', icon: 'üíØ', category: 'entries', check: (stats) => stats.totalEntries >= 100 },
            { id: 'twohundred_entries', name: 'Epic Chronicle', desc: 'Create 200 diary entries', icon: 'üèÜ', category: 'entries', check: (stats) => stats.totalEntries >= 200 },
            { id: 'threesixtyfive_entries', name: 'Year of Stories', desc: 'Create 365 diary entries', icon: 'üìÖ', category: 'entries', check: (stats) => stats.totalEntries >= 365 },

            // Streak achievements
            { id: 'streak_3', name: 'Hot Start', desc: 'Maintain a 3-day streak', icon: 'üî•', category: 'streaks', check: (stats) => stats.currentStreak >= 3 },
            { id: 'streak_7', name: 'Week Warrior', desc: 'Maintain a 7-day streak', icon: '‚≠ê', category: 'streaks', check: (stats) => stats.currentStreak >= 7 },
            { id: 'streak_14', name: 'Two Weeks Strong', desc: 'Maintain a 14-day streak', icon: 'üí™', category: 'streaks', check: (stats) => stats.currentStreak >= 14 },
            { id: 'streak_30', name: 'Monthly Master', desc: 'Maintain a 30-day streak', icon: 'üåü', category: 'streaks', check: (stats) => stats.currentStreak >= 30 },
            { id: 'streak_60', name: 'Unstoppable', desc: 'Maintain a 60-day streak', icon: 'üöÄ', category: 'streaks', check: (stats) => stats.currentStreak >= 60 },
            { id: 'streak_100', name: 'Century Streak', desc: 'Maintain a 100-day streak', icon: 'üëë', category: 'streaks', check: (stats) => stats.currentStreak >= 100 },
            { id: 'streak_200', name: 'Legendary Persistence', desc: 'Maintain a 200-day streak', icon: 'üèÖ', category: 'streaks', check: (stats) => stats.currentStreak >= 200 },
            { id: 'streak_365', name: 'Full Year Champion', desc: 'Maintain a 365-day streak', icon: 'üéä', category: 'streaks', check: (stats) => stats.currentStreak >= 365 },

            // Photo achievements
            { id: 'first_photo', name: 'Picture Perfect', desc: 'Add your first photo', icon: 'üì∑', category: 'photos', check: (stats) => stats.totalPhotos >= 1 },
            { id: 'ten_photos', name: 'Photographer', desc: 'Add 10 photos', icon: 'üì∏', category: 'photos', check: (stats) => stats.totalPhotos >= 10 },
            { id: 'fifty_photos', name: 'Photo Album', desc: 'Add 50 photos', icon: 'üñºÔ∏è', category: 'photos', check: (stats) => stats.totalPhotos >= 50 },
            { id: 'hundred_photos', name: 'Visual Storyteller', desc: 'Add 100 photos', icon: 'üéûÔ∏è', category: 'photos', check: (stats) => stats.totalPhotos >= 100 },
            { id: 'double_photo_day', name: 'Double Vision', desc: 'Add both a kids & self photo in one entry', icon: 'üëØ', category: 'photos', check: (stats) => stats.hasBothPhotosEntry },

            // Mood tracking achievements
            { id: 'all_moods', name: 'Mood Explorer', desc: 'Experience all mood types', icon: 'üé≠', category: 'moods', check: (stats) => stats.uniqueMoods >= 24 },
            { id: 'positive_week', name: 'Sunshine Week', desc: 'Have 70%+ positive moods in a week', icon: '‚òÄÔ∏è', category: 'moods', check: (stats) => stats.positiveWeekPercent >= 70 },
            { id: 'balanced_month', name: 'Balanced Life', desc: 'Have a balanced mood month', icon: '‚öñÔ∏è', category: 'moods', check: (stats) => stats.balancedMonth },
            { id: 'mood_rainbow_10', name: 'Emotional Rainbow', desc: 'Use 10 different mood tags', icon: 'üåà', category: 'moods', check: (stats) => stats.uniqueMoods >= 10 },
            { id: 'triple_mood', name: 'Complex Feelings', desc: 'Select 3+ moods in one entry', icon: 'üé®', category: 'moods', check: (stats) => stats.hasTripleMoodEntry },
            { id: 'grateful_streak_7', name: 'Gratitude Guru', desc: 'Tag "grateful" 7 days in a row', icon: 'üôè', category: 'moods', check: (stats) => stats.gratefulStreak >= 7 },
            { id: 'happy_10', name: 'Joy Collector', desc: 'Tag "happy" in 10 entries', icon: 'üòä', category: 'moods', check: (stats) => stats.happyCount >= 10 },
            { id: 'peaceful_10', name: 'Zen Master', desc: 'Tag "peaceful" in 10 entries', icon: 'üßò', category: 'moods', check: (stats) => stats.peacefulCount >= 10 },
            { id: 'mood_turnaround', name: 'Silver Lining', desc: 'Improve mood rating from 1-2 to 4-5 next day', icon: 'üå§Ô∏è', category: 'moods', check: (stats) => stats.hasMoodTurnaround },

            // Time-based achievements
            { id: 'early_bird', name: 'Early Bird', desc: 'Create entry before 9 AM', icon: 'üåÖ', category: 'time', check: (stats) => stats.earlyEntry },
            { id: 'night_owl', name: 'Night Owl', desc: 'Create entry after 10 PM', icon: 'ü¶â', category: 'time', check: (stats) => stats.lateEntry },
            { id: 'weekend_warrior_5', name: 'Weekend Wanderer', desc: 'Write 5 weekend entries', icon: 'üéâ', category: 'time', check: (stats) => stats.weekendEntries >= 5 },
            { id: 'weekend_warrior_20', name: 'Weekend Warrior', desc: 'Write 20 weekend entries', icon: 'ü•≥', category: 'time', check: (stats) => stats.weekendEntries >= 20 },
            { id: 'monday_motivation_5', name: 'Monday Motivation', desc: 'Write 5 Monday entries', icon: 'üíº', category: 'time', check: (stats) => stats.mondayEntries >= 5 },
            { id: 'lunch_break_writer', name: 'Lunch Break Writer', desc: 'Create entry between 12-1 PM', icon: 'ü•™', category: 'time', check: (stats) => stats.lunchEntry },
            { id: 'midnight_musing', name: 'Midnight Musing', desc: 'Create entry between midnight and 1 AM', icon: 'üåô', category: 'time', check: (stats) => stats.midnightEntry },
            { id: 'golden_hour', name: 'Golden Hour', desc: 'Create entry during sunset (6-8 PM)', icon: 'üåá', category: 'time', check: (stats) => stats.goldenHourEntry },

            // Writing achievements
            { id: 'wordsmith_500', name: 'Wordsmith', desc: 'Write 500+ total words', icon: '‚úíÔ∏è', category: 'writing', check: (stats) => stats.totalWords >= 500 },
            { id: 'novelist_2000', name: 'Novelist', desc: 'Write 2000+ total words', icon: 'üìï', category: 'writing', check: (stats) => stats.totalWords >= 2000 },
            { id: 'author_5000', name: 'Published Author', desc: 'Write 5000+ total words', icon: 'üìò', category: 'writing', check: (stats) => stats.totalWords >= 5000 },
            { id: 'epic_writer_10000', name: 'Epic Saga Writer', desc: 'Write 10,000+ total words', icon: 'üìô', category: 'writing', check: (stats) => stats.totalWords >= 10000 },
            { id: 'long_entry', name: 'Deep Dive', desc: 'Write a single entry with 200+ words', icon: 'üìú', category: 'writing', check: (stats) => stats.hasLongEntry },
            { id: 'complete_entry', name: 'Completionist', desc: 'Fill in all fields in one entry', icon: '‚úÖ', category: 'writing', check: (stats) => stats.hasCompleteEntry },

            // Special achievements
            { id: 'reflection_master', name: 'Deep Thinker', desc: 'Answer 20 daily prompts', icon: 'üí≠', category: 'special', check: (stats) => stats.promptsAnswered >= 20 },
            { id: 'reflection_legend', name: 'Philosophical Mind', desc: 'Answer 50 daily prompts', icon: 'üß†', category: 'special', check: (stats) => stats.promptsAnswered >= 50 },
            { id: 'kids_moments', name: 'Super Parent', desc: 'Record 30 moments with kids', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', category: 'special', check: (stats) => stats.kidsMoments >= 30 },
            { id: 'kids_moments_100', name: 'Family Chronicler', desc: 'Record 100 moments with kids', icon: 'üè†', category: 'special', check: (stats) => stats.kidsMoments >= 100 },
            { id: 'self_care', name: 'Self-Care Champion', desc: 'Record 30 self-care moments', icon: 'üíÜ', category: 'special', check: (stats) => stats.selfMoments >= 30 },
            { id: 'self_care_100', name: 'Wellness Warrior', desc: 'Record 100 self-care moments', icon: 'üå∏', category: 'special', check: (stats) => stats.selfMoments >= 100 },
            { id: 'perfect_rating_10', name: 'Living the Dream', desc: 'Have 10 entries with rating 5', icon: 'üåü', category: 'special', check: (stats) => stats.perfectRatings >= 10 },

            // Fun & Secret achievements
            { id: 'comeback_kid', name: 'Comeback Kid', desc: 'Return after 7+ days away', icon: 'üîÑ', category: 'fun', check: (stats) => stats.hasComeback },
            { id: 'variety_week', name: 'Life Kaleidoscope', desc: 'Use 5+ different moods in one week', icon: 'üîÆ', category: 'fun', check: (stats) => stats.varietyWeek },
            { id: 'triple_threat', name: 'Triple Threat', desc: 'Add text, photo & mood in one entry', icon: '‚ö°', category: 'fun', check: (stats) => stats.hasTripleThreatEntry },
            { id: 'rating_all_5', name: 'Full Spectrum', desc: 'Use all 5 rating numbers at least once', icon: 'üé∞', category: 'fun', check: (stats) => stats.usedAllRatings },
            { id: 'inspired_streak_3', name: 'Creative Spark', desc: 'Feel inspired 3 days in a row', icon: 'üí°', category: 'fun', check: (stats) => stats.inspiredStreak >= 3 },
            { id: 'energetic_5', name: 'Energy Bunny', desc: 'Tag "energetic" in 5 entries', icon: '‚ö°', category: 'fun', check: (stats) => stats.energeticCount >= 5 },
            { id: 'proud_moments_10', name: 'Proud Achiever', desc: 'Tag "proud" in 10 entries', icon: 'üéñÔ∏è', category: 'fun', check: (stats) => stats.proudCount >= 10 },
            { id: 'loved_feeling_10', name: 'Feeling Loved', desc: 'Tag "loved" in 10 entries', icon: 'üíï', category: 'fun', check: (stats) => stats.lovedCount >= 10 },
            { id: 'goose_dedication', name: 'Goose Guardian', desc: 'Use the app for 30 unique days', icon: 'ü™ø', category: 'fun', check: (stats) => stats.uniqueDays >= 30 },
            { id: 'season_writer', name: 'All Seasons', desc: 'Write entries in all 4 seasons', icon: 'üçÇ', category: 'fun', check: (stats) => stats.allSeasons },
            { id: 'monthly_regular', name: 'Monthly Regular', desc: 'Write at least 1 entry every month for 3 months', icon: 'üìÜ', category: 'fun', check: (stats) => stats.consecutiveMonths >= 3 }
        ];

        // Daily prompts
        const prompts = [
            "What made you smile today?",
            "One thing you did well today?",
            "What are you grateful for?",
            "A small win you had today?",
            "What brought you peace today?",
            "What surprised you today?",
            "What did you learn today?",
            "How did you show yourself kindness?",
            "What moment would you relive?",
            "What made you proud today?"
            "What did you do to make young Sam proud?"
            "What small act helped someone in the family today?"
            
        ];

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('DiaryDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains('entries')) {
                        database.createObjectStore('entries', { keyPath: 'date' });
                    }
                    if (!database.objectStoreNames.contains('settings')) {
                        database.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

        async function saveEntryToDB(key, value) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['entries'], 'readwrite');
                const store = transaction.objectStore('entries');
                const request = store.put(value);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getEntryFromDB(key) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['entries'], 'readonly');
                const store = transaction.objectStore('entries');
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAllEntriesFromDB() {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['entries'], 'readonly');
                const store = transaction.objectStore('entries');
                const request = store.getAll();
                request.onsuccess = () => {
                    const entries = {};
                    request.result.forEach(entry => {
                        entries[entry.date] = entry;
                    });
                    resolve(entries);
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function saveSettingToDB(key, value) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                const request = store.put({ key, value });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getSettingFromDB(key) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result ? request.result.value : null);
                request.onerror = () => reject(request.error);
            });
        }

        // Calculate current streak
        async function calculateStreak() {
            const entries = await getAllEntriesFromDB();

            if (Object.keys(entries).length === 0) return 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Check if there's an entry for today
            const todayStr = today.toDateString();
            const hasToday = entries[todayStr] !== undefined;

            let streak = 0;
            let checkDate = new Date(today);

            // If there's an entry today, start streak from today
            // If no entry today, streak must start from yesterday or earlier
            if (hasToday) {
                streak = 1;
                checkDate.setDate(checkDate.getDate() - 1);
            }

            // Count backwards day by day
            while (true) {
                const checkDateStr = checkDate.toDateString();
                if (entries[checkDateStr]) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    // Gap found, streak ends
                    break;
                }
            }

            return streak;
        }

        // Update streak calendar
        async function updateStreakCalendar() {
            const entries = await getAllEntriesFromDB();
            const previousStreak = parseInt(document.getElementById('streakCount').textContent) || 0;
            const streak = await calculateStreak();

            // Update streak number with animation if it increased
            const streakCountEl = document.getElementById('streakCount');
            streakCountEl.textContent = streak;

            if (streak > previousStreak) {
                streakCountEl.classList.add('growing');
                setTimeout(() => streakCountEl.classList.remove('growing'), 500);
            }

            // Update visual states
            const streakCalendar = document.getElementById('streakCalendar');
            const streakInfo = document.getElementById('streakInfo');
            const streakMessage = document.getElementById('streakMessage');
            const progressBar = document.getElementById('streakProgressBar');

            // Calculate progress towards next milestone
            const milestones = [3, 7, 14, 30, 60, 100];
            let nextMilestone = milestones.find(m => m > streak) || 100;
            let previousMilestone = milestones.filter(m => m <= streak).pop() || 0;
            let progress = ((streak - previousMilestone) / (nextMilestone - previousMilestone)) * 100;

            // Update progress bar
            progressBar.style.width = `${progress}%`;

            // Update styles based on streak
            if (streak === 0) {
                streakCalendar.classList.remove('active-streak');
                streakInfo.classList.add('hidden');
                streakMessage.textContent = 'Start your journey!';
            } else {
                streakCalendar.classList.add('active-streak');
                streakInfo.classList.remove('hidden');

                // Update message based on streak
                if (streak === 1) {
                    streakMessage.textContent = 'Great start! Keep going!';
                } else if (streak < 3) {
                    streakMessage.textContent = `${3 - streak} more to reach 3 days! üéØ`;
                } else if (streak < 7) {
                    streakMessage.textContent = `${7 - streak} more to reach a week! ‚≠ê`;
                } else if (streak < 14) {
                    streakMessage.textContent = `${14 - streak} more to reach 2 weeks! üí™`;
                } else if (streak < 30) {
                    streakMessage.textContent = `${30 - streak} more to reach 30 days! üåü`;
                } else if (streak < 60) {
                    streakMessage.textContent = `${60 - streak} more to reach 60 days! üöÄ`;
                } else if (streak < 100) {
                    streakMessage.textContent = `${100 - streak} more to reach 100 days! üëë`;
                } else {
                    streakMessage.textContent = 'Legendary streak! üèÜ';
                }

                // Check if hit a milestone
                if (milestones.includes(streak)) {
                    streakCalendar.classList.add('milestone');
                    setTimeout(() => streakCalendar.classList.remove('milestone'), 600);
                }
            }

            const weekDaysContainer = document.getElementById('weekDays');
            const weekIndicator = document.getElementById('weekIndicator');
            const today = new Date();
            const dayOfWeek = today.getDay();

            // Calculate the start of the current week
            const currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

            // Apply week offset
            const startOfWeek = new Date(currentWeekStart);
            startOfWeek.setDate(currentWeekStart.getDate() + (weekOffset * 7));

            const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

            // Update week indicator
            if (weekOffset === 0) {
                weekIndicator.textContent = 'This Week';
            } else if (weekOffset === -1) {
                weekIndicator.textContent = 'Last Week';
            } else if (weekOffset === 1) {
                weekIndicator.textContent = 'Next Week';
            } else if (weekOffset < 0) {
                weekIndicator.textContent = `${Math.abs(weekOffset)} weeks ago`;
            } else {
                weekIndicator.textContent = `${weekOffset} weeks ahead`;
            }

            // Update navigation buttons state
            const nextWeekBtn = document.getElementById('nextWeek');
            const endOfDisplayWeek = new Date(startOfWeek);
            endOfDisplayWeek.setDate(startOfWeek.getDate() + 6);
            nextWeekBtn.disabled = endOfDisplayWeek >= today;

            weekDaysContainer.innerHTML = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = date.toDateString();
                const hasEntry = entries[dateStr];
                const isToday = date.toDateString() === today.toDateString();
                const isFuture = date > today;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'week-day';

                const dotClasses = ['week-day-dot'];
                if (hasEntry) dotClasses.push('completed');
                if (isToday) dotClasses.push('today');

                // Add opacity for future dates
                const opacity = isFuture ? 'opacity: 0.4;' : '';

                dayDiv.innerHTML = `
                    <div class="week-day-label">${dayLabels[i]}</div>
                    <div class="${dotClasses.join(' ')}" onclick="${!isFuture ? `loadDateEntry('${dateStr}')` : ''}" style="${opacity}${isFuture ? 'cursor: default;' : ''}">
                        ${!hasEntry && !isToday ? `<span class="week-day-number">${date.getDate()}</span>` : ''}
                    </div>
                `;

                weekDaysContainer.appendChild(dayDiv);
            }
        }

        // Load entry for a specific date
        async function loadDateEntry(dateStr) {
            const date = new Date(dateStr);
            const entry = await getEntryFromDB(dateStr);

            if (entry) {
                // Edit existing entry
                await editEntry(dateStr);
            } else {
                // Create new entry for this date
                editingDate = dateStr;
                document.getElementById('currentDate').textContent = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                document.getElementById('currentDay').textContent = date.toLocaleDateString('en-US', { weekday: 'long' });
                document.getElementById('editingBadge').style.display = 'block';

                // Clear form
                clearForm();

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Clear the form
        function clearForm() {
            currentRating = 0;
            selectedMoods = [];
            kidsPhotoData = null;
            selfPhotoData = null;

            document.querySelectorAll('.mood-number').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.mood-tag').forEach(t => t.classList.remove('active'));

            document.getElementById('kidsText').value = '';
            document.getElementById('selfText').value = '';
            document.getElementById('promptAnswer').value = '';

            document.getElementById('kidsPhotoPreview').classList.remove('has-photo');
            document.getElementById('selfPhotoPreview').classList.remove('has-photo');
            document.getElementById('kidsPhoto').value = '';
            document.getElementById('selfPhoto').value = '';
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            initializeApp();
            setupEventListeners();
            updateCurrentDate();
            await loadTodayEntry();
            await checkForPrompt();
            await updateStreakCalendar();
            await checkAndUnlockAchievements();
            await updateAchievementBadge();

            // Set max date for date picker to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').max = today;

            // Remove goose after animation completes
            setTimeout(() => {
                const goose = document.getElementById('animatedGoose');
                if (goose) {
                    goose.remove();
                }
            }, 8000);
        });

        function initializeApp() {
            // Check for dark mode preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
            }

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('darkModeToggle').textContent = '‚òÄÔøΩÔøΩÔøΩ';
                } else {
                    document.documentElement.classList.remove('dark');
                    document.getElementById('darkModeToggle').textContent = 'üåô';
                }
            });

            // Initialize Web Speech API
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (currentVoiceInput) {
                        currentVoiceInput.value += (currentVoiceInput.value ? ' ' : '') + transcript;
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (currentVoiceInput && currentVoiceInput.dataset.voiceBtn) {
                        document.getElementById(currentVoiceInput.dataset.voiceBtn).classList.remove('recording');
                    }
                };

                recognition.onend = () => {
                    if (currentVoiceInput && currentVoiceInput.dataset.voiceBtn) {
                        document.getElementById(currentVoiceInput.dataset.voiceBtn).classList.remove('recording');
                    }
                };
            }
        }

        function setupEventListeners() {
            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                document.getElementById('darkModeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            });

            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const view = tab.dataset.view;
                    switchView(view);
                });
            });

            // Mood rating
            document.querySelectorAll('.mood-number').forEach(number => {
                number.addEventListener('click', () => {
                    const rating = parseInt(number.dataset.rating);
                    setMoodRating(rating);
                });
            });

            // Mood tags
            document.querySelectorAll('.mood-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    toggleMoodTag(tag);
                });
            });

            // Photo uploads
            document.getElementById('kidsPhoto').addEventListener('change', (e) => {
                handlePhotoUpload(e, 'kids');
            });

            document.getElementById('selfPhoto').addEventListener('change', (e) => {
                handlePhotoUpload(e, 'self');
            });

            // Remove photos
            document.getElementById('removeKidsPhoto').addEventListener('click', () => {
                removePhoto('kids');
            });

            document.getElementById('removeSelfPhoto').addEventListener('click', () => {
                removePhoto('self');
            });

            // Voice input buttons
            document.getElementById('kidsVoiceBtn').addEventListener('click', () => {
                startVoiceInput('kidsText', 'kidsVoiceBtn');
            });

            document.getElementById('selfVoiceBtn').addEventListener('click', () => {
                startVoiceInput('selfText', 'selfVoiceBtn');
            });

            document.getElementById('promptVoiceBtn').addEventListener('click', () => {
                startVoiceInput('promptAnswer', 'promptVoiceBtn');
            });

            // Save entry
            document.getElementById('saveEntry').addEventListener('click', saveEntry);

            // Timeline filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    await loadTimeline(btn.dataset.filter);
                });
            });

            // Month navigation
            document.getElementById('prevMonth').addEventListener('click', async () => {
                currentMonthOffset--;
                await updateMonthlyView();
            });

            document.getElementById('nextMonth').addEventListener('click', async () => {
                if (currentMonthOffset < 0) {
                    currentMonthOffset++;
                    await updateMonthlyView();
                }
            });

            // Photo modal
            document.getElementById('closePhotoModal').addEventListener('click', () => {
                document.getElementById('photoModal').classList.remove('active');
            });

            document.getElementById('photoModal').addEventListener('click', (e) => {
                if (e.target.id === 'photoModal') {
                    document.getElementById('photoModal').classList.remove('active');
                }
            });

            // Achievements modal
            document.getElementById('achievementsBtn').addEventListener('click', () => {
                openAchievementsModal();
            });

            document.getElementById('closeAchievementsModal').addEventListener('click', () => {
                document.getElementById('achievementsModal').classList.remove('active');
            });

            document.getElementById('achievementsModal').addEventListener('click', (e) => {
                if (e.target.id === 'achievementsModal') {
                    document.getElementById('achievementsModal').classList.remove('active');
                }
            });

            // Cancel edit button
            document.getElementById('cancelEdit').addEventListener('click', () => {
                cancelEdit();
            });

            // Week navigation buttons
            document.getElementById('prevWeek').addEventListener('click', async () => {
                weekOffset--;
                await updateStreakCalendar();
            });

            document.getElementById('nextWeek').addEventListener('click', async () => {
                if (weekOffset < 0) {
                    weekOffset++;
                    await updateStreakCalendar();
                }
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('currentDay').textContent = now.toLocaleDateString('en-US', { weekday: 'long' });
        }

        async function checkForPrompt() {
            const today = new Date().toDateString();
            const lastPromptDate = await getSettingFromDB('lastPromptDate');
            const lastPromptText = await getSettingFromDB('lastPromptText');

            // If it's a new day, pick a new random prompt
            if (lastPromptDate !== today) {
                const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
                document.getElementById('promptQuestion').textContent = randomPrompt;
                await saveSettingToDB('lastPromptText', randomPrompt);
            } else if (lastPromptText) {
                // Show the same prompt for today
                document.getElementById('promptQuestion').textContent = lastPromptText;
            } else {
                // Fallback to random prompt
                const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
                document.getElementById('promptQuestion').textContent = randomPrompt;
            }
        }

        function setMoodRating(rating) {
            currentRating = rating;
            document.querySelectorAll('.mood-number').forEach((number, index) => {
                if (index + 1 === rating) {
                    number.classList.add('active');
                } else {
                    number.classList.remove('active');
                }
            });
        }

        function toggleMoodTag(tag) {
            const mood = tag.dataset.mood;
            if (tag.classList.contains('active')) {
                tag.classList.remove('active');
                selectedMoods = selectedMoods.filter(m => m !== mood);
            } else {
                tag.classList.add('active');
                selectedMoods.push(mood);
            }
        }

        function handlePhotoUpload(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const photoData = e.target.result;
                    if (type === 'kids') {
                        kidsPhotoData = photoData;
                        document.getElementById('kidsPhotoImg').src = photoData;
                        document.getElementById('kidsPhotoPreview').classList.add('has-photo');
                    } else {
                        selfPhotoData = photoData;
                        document.getElementById('selfPhotoImg').src = photoData;
                        document.getElementById('selfPhotoPreview').classList.add('has-photo');
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto(type) {
            if (type === 'kids') {
                kidsPhotoData = null;
                document.getElementById('kidsPhotoPreview').classList.remove('has-photo');
                document.getElementById('kidsPhoto').value = '';
            } else {
                selfPhotoData = null;
                document.getElementById('selfPhotoPreview').classList.remove('has-photo');
                document.getElementById('selfPhoto').value = '';
            }
        }

        function startVoiceInput(textareaId, btnId) {
            if (!recognition) {
                showMessage('Voice input is not supported in your browser', 'error');
                return;
            }

            const textarea = document.getElementById(textareaId);
            const btn = document.getElementById(btnId);

            currentVoiceInput = textarea;
            currentVoiceInput.dataset.voiceBtn = btnId;

            btn.classList.add('recording');
            recognition.start();
        }

        async function saveEntry() {
            const kidsText = document.getElementById('kidsText').value.trim();
            const selfText = document.getElementById('selfText').value.trim();
            const promptAnswer = document.getElementById('promptAnswer').value.trim();

            if (!currentRating && !kidsText && !selfText && !promptAnswer) {
                showMessage('Please add at least some content to save your entry', 'error');
                return;
            }

            const dateToSave = editingDate || new Date().toDateString();
            const entry = {
                date: dateToSave,
                timestamp: new Date().toISOString(),
                rating: currentRating,
                kidsText,
                kidsPhoto: kidsPhotoData,
                selfText,
                selfPhoto: selfPhotoData,
                moods: selectedMoods,
                promptAnswer,
                promptQuestion: document.getElementById('promptQuestion').textContent
            };

            // Save to IndexedDB
            await saveEntryToDB(dateToSave, entry);

            // Update last prompt date
            if (!editingDate) {
                await saveSettingToDB('lastPromptDate', dateToSave);
                await saveSettingToDB('lastPromptText', entry.promptQuestion);
            }

            // Trigger celebration animation
            triggerCelebration();

            showMessage(editingDate ? '‚ú® Entry updated successfully!' : '‚ú® Entry saved successfully!', 'success');

            // Update streak calendar
            await updateStreakCalendar();

            // Check for new achievements
            await checkAndUnlockAchievements();

            if (editingDate) {
                cancelEdit();
            }
        }

        function triggerCelebration() {
            const saveBtn = document.getElementById('saveEntry');

            // Animate save button
            saveBtn.classList.add('celebrating');
            setTimeout(() => {
                saveBtn.classList.remove('celebrating');
            }, 600);

            // Create confetti overlay
            const overlay = document.createElement('div');
            overlay.className = 'celebration-overlay';
            document.body.appendChild(overlay);

            // Generate confetti pieces
            const colors = ['#f6c85f', '#6eb5a0', '#e89e6f', '#f19c79', '#ffd166', '#a8c5b9', '#e5a3b4'];
            const confettiCount = 50;

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';

                // Random positioning and styling
                const left = Math.random() * 100;
                const delay = Math.random() * 0.5;
                const duration = 2 + Math.random() * 1;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const size = 8 + Math.random() * 6;

                confetti.style.left = `${left}%`;
                confetti.style.backgroundColor = color;
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                confetti.style.animationDelay = `${delay}s`;
                confetti.style.animationDuration = `${duration}s`;

                overlay.appendChild(confetti);
            }

            // Remove overlay after animation completes
            setTimeout(() => {
                overlay.remove();
            }, 3500);
        }

        async function editEntry(dateStr) {
            editingDate = dateStr;
            const entry = await getEntryFromDB(dateStr);

            if (!entry) return;

            // Switch to daily view
            await switchView('daily');

            // Update UI to show editing mode
            const date = new Date(dateStr);
            document.getElementById('currentDate').textContent = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('currentDay').textContent = date.toLocaleDateString('en-US', { weekday: 'long' });
            document.getElementById('editingBadge').style.display = 'block';

            // Load entry data
            if (entry.rating) {
                setMoodRating(entry.rating);
            }

            document.getElementById('kidsText').value = entry.kidsText || '';
            document.getElementById('selfText').value = entry.selfText || '';
            document.getElementById('promptAnswer').value = entry.promptAnswer || '';

            if (entry.kidsPhoto) {
                kidsPhotoData = entry.kidsPhoto;
                document.getElementById('kidsPhotoImg').src = entry.kidsPhoto;
                document.getElementById('kidsPhotoPreview').classList.add('has-photo');
            }

            if (entry.selfPhoto) {
                selfPhotoData = entry.selfPhoto;
                document.getElementById('selfPhotoImg').src = entry.selfPhoto;
                document.getElementById('selfPhotoPreview').classList.add('has-photo');
            }

            if (entry.moods) {
                selectedMoods = [...entry.moods];
                document.querySelectorAll('.mood-tag').forEach(tag => {
                    if (selectedMoods.includes(tag.dataset.mood)) {
                        tag.classList.add('active');
                    } else {
                        tag.classList.remove('active');
                    }
                });
            }

            if (entry.promptQuestion) {
                document.getElementById('promptQuestion').textContent = entry.promptQuestion;
            } else {
                // If no prompt saved, show today's prompt
                await checkForPrompt();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function cancelEdit() {
            editingDate = null;
            weekOffset = 0; // Reset to current week
            document.getElementById('editingBadge').style.display = 'none';
            updateCurrentDate();
            await loadTodayEntry();
            await updateStreakCalendar();
        }

        async function loadTodayEntry() {
            const today = new Date().toDateString();
            const entry = await getEntryFromDB(today);

            // Clear form first
            clearForm();

            if (entry) {
                // Load existing entry
                if (entry.rating) {
                    setMoodRating(entry.rating);
                }

                document.getElementById('kidsText').value = entry.kidsText || '';
                document.getElementById('selfText').value = entry.selfText || '';
                document.getElementById('promptAnswer').value = entry.promptAnswer || '';

                if (entry.kidsPhoto) {
                    kidsPhotoData = entry.kidsPhoto;
                    document.getElementById('kidsPhotoImg').src = entry.kidsPhoto;
                    document.getElementById('kidsPhotoPreview').classList.add('has-photo');
                }

                if (entry.selfPhoto) {
                    selfPhotoData = entry.selfPhoto;
                    document.getElementById('selfPhotoImg').src = entry.selfPhoto;
                    document.getElementById('selfPhotoPreview').classList.add('has-photo');
                }

                if (entry.moods) {
                    selectedMoods = entry.moods;
                    document.querySelectorAll('.mood-tag').forEach(tag => {
                        if (selectedMoods.includes(tag.dataset.mood)) {
                            tag.classList.add('active');
                        }
                    });
                }
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('successMessage');
            container.innerHTML = `<div class="success-message">${message}</div>`;

            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        async function switchView(view) {
            currentView = view;

            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });

            // Update view containers
            document.querySelectorAll('.view-container').forEach(container => {
                container.classList.remove('active');
            });

            document.getElementById(`${view}-view`).classList.add('active');

            // Load view-specific data
            if (view === 'timeline') {
                await loadTimeline('all');
            } else if (view === 'weekly') {
                await updateWeeklyView();
            } else if (view === 'monthly') {
                await updateMonthlyView();
            } else if (view === 'daily') {
                await updateStreakCalendar();
            }
        }

        async function loadTimeline(filter) {
            const entries = await getAllEntriesFromDB();
            const container = document.getElementById('timelineEntries');
            const flashbackContainer = document.getElementById('flashbackContainer');

            // Show flashback
            const flashback = await getRandomFlashback();
            if (flashback) {
                flashbackContainer.innerHTML = `
                    <div class="flashback-card">
                        <div class="flashback-label">‚ú® Flashback</div>
                        <div class="flashback-date">${new Date(flashback.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                        <div class="flashback-text">${flashback.text}</div>
                    </div>
                `;
            } else {
                flashbackContainer.innerHTML = '';
            }

            // Filter entries
            let filteredEntries = Object.values(entries);
            const now = new Date();

            if (filter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredEntries = filteredEntries.filter(e => new Date(e.date) >= weekAgo);
            } else if (filter === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredEntries = filteredEntries.filter(e => new Date(e.date) >= monthAgo);
            }

            // Sort by date (newest first)
            filteredEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredEntries.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No entries yet. Start writing your first moment!</p></div>';
                return;
            }

            container.innerHTML = filteredEntries.map(entry => {
                const date = new Date(entry.date);
                const specialMoment = entry.kidsText || entry.selfText || entry.promptAnswer || '';
                const photo = entry.kidsPhoto || entry.selfPhoto;
                const moodColor = entry.moods && entry.moods.length > 0
                    ? `var(--mood-${entry.moods[0]})`
                    : 'var(--color-primary)';

                return `
                    <div class="moment-card" style="border-left-color: ${moodColor}" onclick="editEntry('${entry.date}')">
                        <div class="moment-date">${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                        ${entry.rating ? `
                            <div class="moment-rating">
                                ${'‚≠ê'.repeat(entry.rating)}
                            </div>
                        ` : ''}
                        ${entry.kidsText ? `<div class="moment-text"><strong>Kids:</strong> ${entry.kidsText}</div>` : ''}
                        ${entry.selfText ? `<div class="moment-text"><strong>Self:</strong> ${entry.selfText}</div>` : ''}
                        ${entry.promptAnswer && entry.promptQuestion ? `
                            <div class="moment-text">
                                <strong>${entry.promptQuestion}</strong><br>
                                ${entry.promptAnswer}
                            </div>
                        ` : ''}
                        ${entry.moods && entry.moods.length > 0 ? `
                            <div class="moment-moods">
                                ${entry.moods.map(mood => `
                                    <span class="moment-mood-badge" style="background: var(--mood-${mood}); color: white;">
                                        ${mood}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${photo ? `
                            <div class="moment-photo">
                                <img src="${photo}" alt="Moment photo" onclick="event.stopPropagation(); showPhotoModal('${photo}')">
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function getRandomFlashback() {
            const entriesObj = await getAllEntriesFromDB();
            const entries = Object.values(entriesObj);
            const today = new Date().toDateString();
            const oldEntries = entries.filter(e => e.date !== today && new Date(e.date) < new Date());

            if (oldEntries.length === 0) return null;

            const random = oldEntries[Math.floor(Math.random() * oldEntries.length)];
            const text = random.kidsText || random.selfText || random.promptAnswer;

            return text ? { date: random.date, text } : null;
        }

        async function updateWeeklyView() {
            const entriesObj = await getAllEntriesFromDB();
            const entries = Object.values(entriesObj);

            // Get current time in UK timezone
            const now = new Date();
            const ukTime = new Date(now.toLocaleString('en-US', { timeZone: 'Europe/London' }));

            // Find the most recent Monday at midnight UK time
            const dayOfWeek = ukTime.getDay();
            const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Sunday = 0, Monday = 1
            const mondayMidnight = new Date(ukTime);
            mondayMidnight.setDate(ukTime.getDate() - daysToMonday);
            mondayMidnight.setHours(0, 0, 0, 0);

            const weekEntries = entries.filter(e => new Date(e.date) >= mondayMidnight);

            // Average mood
            const avgMood = weekEntries.length > 0
                ? (weekEntries.reduce((sum, e) => sum + (e.rating || 0), 0) / weekEntries.filter(e => e.rating).length).toFixed(1)
                : '-';
            document.getElementById('weeklyAvgMood').textContent = avgMood !== 'NaN' ? `${avgMood} ‚≠ê` : '-';
            document.getElementById('weeklyEntryCount').textContent = weekEntries.length;

            // Mood balance
            const sentiment = getMoodSentiment(weekEntries);
            renderMoodBalance(sentiment, 'weeklyMoodBalance');

            // Mood word cloud
            const moodWords = extractMoodWords(weekEntries);
            const wordCloudEl = document.getElementById('weeklyWordCloud');
            if (moodWords.length > 0) {
                wordCloudEl.innerHTML = moodWords.slice(0, 12).map(([mood, count]) => {
                    const size = Math.min(0.85 + count * 0.15, 1.6);
                    const moodColor = `var(--mood-${mood})`;
                    const emoji = document.querySelector(`[data-mood="${mood}"]`)?.textContent.split(' ')[0] || '';
                    return `<span class="word-cloud-item" style="font-size: ${size}rem; background: ${moodColor};">${emoji} ${mood} (${count})</span>`;
                }).join('');
            } else {
                wordCloudEl.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center;">No mood data yet this week</p>';
            }

            // Photos
            const photos = weekEntries.flatMap(e => [e.kidsPhoto, e.selfPhoto]).filter(Boolean);
            const photosEl = document.getElementById('weeklyPhotos');
            if (photos.length > 0) {
                photosEl.innerHTML = photos.map(photo => `
                    <div class="photo-grid-item" onclick="showPhotoModal('${photo}')">
                        <img src="${photo}" alt="Week photo">
                    </div>
                `).join('');
            } else {
                photosEl.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center; padding: 2rem;">No photos this week</p>';
            }
        }

        async function updateMonthlyView() {
            const now = new Date();
            const targetMonth = new Date(now.getFullYear(), now.getMonth() + currentMonthOffset, 1);
            const monthName = targetMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonth').textContent = monthName;

            const entriesObj = await getAllEntriesFromDB();
            const entries = Object.values(entriesObj);
            const monthEntries = entries.filter(e => {
                const entryDate = new Date(e.date);
                return entryDate.getMonth() === targetMonth.getMonth() &&
                       entryDate.getFullYear() === targetMonth.getFullYear();
            });

            // Statistics
            const avgMood = monthEntries.length > 0
                ? (monthEntries.reduce((sum, e) => sum + (e.rating || 0), 0) / monthEntries.filter(e => e.rating).length).toFixed(1)
                : '-';
            document.getElementById('monthlyAvgMood').textContent = avgMood !== 'NaN' ? `${avgMood} ‚≠ê` : '-';
            document.getElementById('monthlyEntryCount').textContent = monthEntries.length;

            // Mood chart
            const chartEl = document.getElementById('monthlyMoodChart');
            const labelsEl = document.getElementById('monthlyMoodLabels');
            const daysInMonth = new Date(targetMonth.getFullYear(), targetMonth.getMonth() + 1, 0).getDate();
            const weeks = Math.ceil(daysInMonth / 7);

            const weeklyMoods = [];
            for (let i = 0; i < weeks; i++) {
                const weekStart = i * 7 + 1;
                const weekEnd = Math.min((i + 1) * 7, daysInMonth);
                const weekEntries = monthEntries.filter(e => {
                    const day = new Date(e.date).getDate();
                    return day >= weekStart && day <= weekEnd;
                });
                const weekAvg = weekEntries.length > 0
                    ? weekEntries.reduce((sum, e) => sum + (e.rating || 0), 0) / weekEntries.filter(e => e.rating).length
                    : 0;
                weeklyMoods.push(weekAvg);
            }

            const maxMood = Math.max(...weeklyMoods, 5);
            chartEl.innerHTML = weeklyMoods.map((mood, i) => {
                const height = (mood / maxMood) * 100;
                return `<div class="chart-bar" style="height: ${height}%" data-value="${mood.toFixed(1)}"></div>`;
            }).join('');

            labelsEl.innerHTML = weeklyMoods.map((_, i) => `
                <div class="chart-label">Week ${i + 1}</div>
            `).join('');

            // Mood balance
            const sentiment = getMoodSentiment(monthEntries);
            renderMoodBalance(sentiment, 'monthlyMoodBalance');

            // Mood word cloud
            const moodWords = extractMoodWords(monthEntries);
            const wordCloudEl = document.getElementById('monthlyWordCloud');
            if (moodWords.length > 0) {
                wordCloudEl.innerHTML = moodWords.slice(0, 15).map(([mood, count]) => {
                    const size = Math.min(0.85 + count * 0.12, 1.6);
                    const moodColor = `var(--mood-${mood})`;
                    const emoji = document.querySelector(`[data-mood="${mood}"]`)?.textContent.split(' ')[0] || '';
                    return `<span class="word-cloud-item" style="font-size: ${size}rem; background: ${moodColor};">${emoji} ${mood} (${count})</span>`;
                }).join('');
            } else {
                wordCloudEl.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center;">No mood data yet this month</p>';
            }

            // Photos
            const photos = monthEntries.flatMap(e => [e.kidsPhoto, e.selfPhoto]).filter(Boolean);
            const photosEl = document.getElementById('monthlyPhotos');
            if (photos.length > 0) {
                photosEl.innerHTML = photos.map(photo => `
                    <div class="photo-grid-item" onclick="showPhotoModal('${photo}')">
                        <img src="${photo}" alt="Month photo">
                    </div>
                `).join('');
            } else {
                photosEl.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center; padding: 2rem;">No photos this month</p>';
            }
        }

        function extractMoodWords(entries) {
            const moodCount = {};

            entries.forEach(entry => {
                if (entry.moods && entry.moods.length > 0) {
                    entry.moods.forEach(mood => {
                        moodCount[mood] = (moodCount[mood] || 0) + 1;
                    });
                }
            });

            return Object.entries(moodCount)
                .sort((a, b) => b[1] - a[1]);
        }

        function getMoodSentiment(entries) {
            let positiveCount = 0;
            let negativeCount = 0;

            entries.forEach(entry => {
                if (entry.moods && entry.moods.length > 0) {
                    entry.moods.forEach(mood => {
                        if (positiveMoods.includes(mood)) {
                            positiveCount++;
                        } else if (negativeMoods.includes(mood)) {
                            negativeCount++;
                        }
                    });
                }
            });

            return { positiveCount, negativeCount };
        }

        function renderMoodBalance(sentiment, containerId) {
            const { positiveCount, negativeCount } = sentiment;
            const total = positiveCount + negativeCount;

            if (total === 0) {
                document.getElementById(containerId).innerHTML = `
                    <p style="color: var(--color-text-secondary); text-align: center; padding: 1rem;">
                        No mood data yet. Start tracking your feelings!
                    </p>
                `;
                return;
            }

            const positivePercent = (positiveCount / total) * 100;
            const negativePercent = (negativeCount / total) * 100;

            let message = '';
            if (positivePercent > 70) {
                message = 'üåü Wow! Your vibes have been mostly positive!';
            } else if (positivePercent > 50) {
                message = 'üòä More positive than negative‚Äîkeep it up!';
            } else if (negativePercent > 70) {
                message = 'üíô Tough times lately. Remember to be kind to yourself.';
            } else {
                message = '‚öñÔ∏è A balanced mix of highs and lows‚Äîthat\'s life!';
            }

            document.getElementById(containerId).innerHTML = `
                <div class="mood-sentiment-message">${message}</div>
                <div class="mood-balance-bars">
                    <div class="mood-balance-bar">
                        <div class="mood-balance-emoji">üòä</div>
                        <div class="mood-balance-label" style="color: var(--mood-grateful);">Positive</div>
                        <div class="mood-balance-visual">
                            <div class="mood-balance-fill positive" style="height: ${positivePercent}%;" data-count="${positiveCount}"></div>
                        </div>
                    </div>
                    <div class="mood-balance-bar">
                        <div class="mood-balance-emoji">üòî</div>
                        <div class="mood-balance-label" style="color: var(--mood-stressed);">Challenging</div>
                        <div class="mood-balance-visual">
                            <div class="mood-balance-fill negative" style="height: ${negativePercent}%;" data-count="${negativeCount}"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== ACHIEVEMENTS SYSTEM ==========

        async function getUnlockedAchievements() {
            const unlocked = await getSettingFromDB('unlockedAchievements');
            return unlocked || [];
        }

        async function saveUnlockedAchievements(unlocked) {
            await saveSettingToDB('unlockedAchievements', unlocked);
        }

        async function calculateAchievementStats() {
            const entries = await getAllEntriesFromDB();
            const entriesArray = Object.values(entries);
            const currentStreak = await calculateStreak();

            // Count totals
            const totalEntries = entriesArray.length;
            const totalPhotos = entriesArray.reduce((count, e) => {
                return count + (e.kidsPhoto ? 1 : 0) + (e.selfPhoto ? 1 : 0);
            }, 0);

            // Count unique moods
            const allMoods = new Set();
            entriesArray.forEach(e => {
                if (e.moods) e.moods.forEach(m => allMoods.add(m));
            });
            const uniqueMoods = allMoods.size;

            // Count prompts answered
            const promptsAnswered = entriesArray.filter(e => e.promptAnswer && e.promptAnswer.trim()).length;

            // Count kids and self moments
            const kidsMoments = entriesArray.filter(e => e.kidsText && e.kidsText.trim()).length;
            const selfMoments = entriesArray.filter(e => e.selfText && e.selfText.trim()).length;

            // Time-based checks
            const now = new Date();
            let earlyEntry = false;
            let lateEntry = false;
            let lunchEntry = false;
            let midnightEntry = false;
            let goldenHourEntry = false;
            let weekendEntries = 0;
            let mondayEntries = 0;

            entriesArray.forEach(e => {
                const entryTime = new Date(e.timestamp);
                const hour = entryTime.getHours();
                const dayOfWeek = entryTime.getDay();

                if (hour < 9) earlyEntry = true;
                if (hour >= 22) lateEntry = true;
                if (hour >= 12 && hour < 13) lunchEntry = true;
                if (hour >= 0 && hour < 1) midnightEntry = true;
                if (hour >= 18 && hour < 20) goldenHourEntry = true;
                if (dayOfWeek === 0 || dayOfWeek === 6) weekendEntries++;
                if (dayOfWeek === 1) mondayEntries++;
            });

            // Calculate positive week percentage
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const weekEntries = entriesArray.filter(e => new Date(e.date) >= weekAgo);
            let positiveCount = 0, negativeCount = 0;
            weekEntries.forEach(e => {
                if (e.moods) {
                    e.moods.forEach(m => {
                        if (positiveMoods.includes(m)) positiveCount++;
                        else if (negativeMoods.includes(m)) negativeCount++;
                    });
                }
            });
            const positiveWeekPercent = (positiveCount + negativeCount > 0)
                ? (positiveCount / (positiveCount + negativeCount)) * 100
                : 0;

            // Check for balanced month (40-60% positive)
            const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            const monthEntries = entriesArray.filter(e => new Date(e.date) >= monthAgo);
            let monthPositive = 0, monthNegative = 0;
            monthEntries.forEach(e => {
                if (e.moods) {
                    e.moods.forEach(m => {
                        if (positiveMoods.includes(m)) monthPositive++;
                        else if (negativeMoods.includes(m)) monthNegative++;
                    });
                }
            });
            const monthTotal = monthPositive + monthNegative;
            const monthPositivePercent = monthTotal > 0 ? (monthPositive / monthTotal) * 100 : 0;
            const balancedMonth = monthPositivePercent >= 40 && monthPositivePercent <= 60;

            // Writing stats
            let totalWords = 0;
            let hasLongEntry = false;
            let hasCompleteEntry = false;
            let hasBothPhotosEntry = false;
            let hasTripleMoodEntry = false;
            let hasTripleThreatEntry = false;
            const usedRatings = new Set();
            let perfectRatings = 0;

            entriesArray.forEach(e => {
                const kidsWords = e.kidsText ? e.kidsText.trim().split(/\s+/).filter(w => w).length : 0;
                const selfWords = e.selfText ? e.selfText.trim().split(/\s+/).filter(w => w).length : 0;
                const promptWords = e.promptAnswer ? e.promptAnswer.trim().split(/\s+/).filter(w => w).length : 0;
                const entryWords = kidsWords + selfWords + promptWords;
                totalWords += entryWords;

                if (entryWords >= 200) hasLongEntry = true;

                // Check for complete entry (rating + moods + kids text + self text + prompt answer)
                if (e.rating && e.moods?.length > 0 && e.kidsText?.trim() && e.selfText?.trim() && e.promptAnswer?.trim()) {
                    hasCompleteEntry = true;
                }

                // Check for both photos in one entry
                if (e.kidsPhoto && e.selfPhoto) hasBothPhotosEntry = true;

                // Check for triple mood entry
                if (e.moods && e.moods.length >= 3) hasTripleMoodEntry = true;

                // Check for triple threat (text + photo + mood)
                if ((e.kidsText?.trim() || e.selfText?.trim()) && (e.kidsPhoto || e.selfPhoto) && e.moods?.length > 0) {
                    hasTripleThreatEntry = true;
                }

                // Track ratings used
                if (e.rating) usedRatings.add(e.rating);

                // Count perfect ratings
                if (e.rating === 5) perfectRatings++;
            });

            const usedAllRatings = usedRatings.size >= 5;

            // Mood-specific counts
            let happyCount = 0, peacefulCount = 0, energeticCount = 0, proudCount = 0, lovedCount = 0;
            entriesArray.forEach(e => {
                if (e.moods) {
                    if (e.moods.includes('happy')) happyCount++;
                    if (e.moods.includes('peaceful')) peacefulCount++;
                    if (e.moods.includes('energetic')) energeticCount++;
                    if (e.moods.includes('proud')) proudCount++;
                    if (e.moods.includes('loved')) lovedCount++;
                }
            });

            // Calculate mood streaks (grateful, inspired)
            const sortedEntries = [...entriesArray].sort((a, b) => new Date(a.date) - new Date(b.date));
            let gratefulStreak = 0, maxGratefulStreak = 0;
            let inspiredStreak = 0, maxInspiredStreak = 0;
            let prevDate = null;

            sortedEntries.forEach(e => {
                const currentDate = new Date(e.date);
                const isConsecutive = prevDate && (currentDate - prevDate) / (1000 * 60 * 60 * 24) <= 1;

                if (e.moods?.includes('grateful')) {
                    gratefulStreak = isConsecutive ? gratefulStreak + 1 : 1;
                    maxGratefulStreak = Math.max(maxGratefulStreak, gratefulStreak);
                } else {
                    gratefulStreak = 0;
                }

                if (e.moods?.includes('inspired')) {
                    inspiredStreak = isConsecutive ? inspiredStreak + 1 : 1;
                    maxInspiredStreak = Math.max(maxInspiredStreak, inspiredStreak);
                } else {
                    inspiredStreak = 0;
                }

                prevDate = currentDate;
            });

            // Check for mood turnaround (bad day followed by good day)
            let hasMoodTurnaround = false;
            for (let i = 1; i < sortedEntries.length; i++) {
                const prevEntry = sortedEntries[i - 1];
                const currEntry = sortedEntries[i];
                const prevDate2 = new Date(prevEntry.date);
                const currDate = new Date(currEntry.date);
                const dayDiff = (currDate - prevDate2) / (1000 * 60 * 60 * 24);

                if (dayDiff === 1 && prevEntry.rating <= 2 && currEntry.rating >= 4) {
                    hasMoodTurnaround = true;
                    break;
                }
            }

            // Check for variety week (5+ different moods in one week)
            let varietyWeek = false;
            const weekMoods = new Set();
            weekEntries.forEach(e => {
                if (e.moods) e.moods.forEach(m => weekMoods.add(m));
            });
            varietyWeek = weekMoods.size >= 5;

            // Check for comeback (7+ days gap then return)
            let hasComeback = false;
            for (let i = 1; i < sortedEntries.length; i++) {
                const prevDate3 = new Date(sortedEntries[i - 1].date);
                const currDate = new Date(sortedEntries[i].date);
                const gap = (currDate - prevDate3) / (1000 * 60 * 60 * 24);
                if (gap >= 7) {
                    hasComeback = true;
                    break;
                }
            }

            // Count unique days
            const uniqueDays = new Set(entriesArray.map(e => e.date)).size;

            // Check for all seasons
            const seasons = new Set();
            entriesArray.forEach(e => {
                const month = new Date(e.date).getMonth();
                if (month >= 2 && month <= 4) seasons.add('spring');
                else if (month >= 5 && month <= 7) seasons.add('summer');
                else if (month >= 8 && month <= 10) seasons.add('fall');
                else seasons.add('winter');
            });
            const allSeasons = seasons.size >= 4;

            // Check for consecutive months
            const monthsWithEntries = new Set();
            entriesArray.forEach(e => {
                const date = new Date(e.date);
                monthsWithEntries.add(`${date.getFullYear()}-${date.getMonth()}`);
            });
            const sortedMonths = [...monthsWithEntries].sort();
            let consecutiveMonths = 1, maxConsecutiveMonths = 1;
            for (let i = 1; i < sortedMonths.length; i++) {
                const [prevY, prevM] = sortedMonths[i - 1].split('-').map(Number);
                const [currY, currM] = sortedMonths[i].split('-').map(Number);
                const prevTotal = prevY * 12 + prevM;
                const currTotal = currY * 12 + currM;
                if (currTotal - prevTotal === 1) {
                    consecutiveMonths++;
                    maxConsecutiveMonths = Math.max(maxConsecutiveMonths, consecutiveMonths);
                } else {
                    consecutiveMonths = 1;
                }
            }

            return {
                totalEntries,
                totalPhotos,
                currentStreak,
                uniqueMoods,
                promptsAnswered,
                kidsMoments,
                selfMoments,
                earlyEntry,
                lateEntry,
                lunchEntry,
                midnightEntry,
                goldenHourEntry,
                weekendEntries,
                mondayEntries,
                positiveWeekPercent,
                balancedMonth,
                totalWords,
                hasLongEntry,
                hasCompleteEntry,
                hasBothPhotosEntry,
                hasTripleMoodEntry,
                hasTripleThreatEntry,
                usedAllRatings,
                perfectRatings,
                happyCount,
                peacefulCount,
                energeticCount,
                proudCount,
                lovedCount,
                gratefulStreak: maxGratefulStreak,
                inspiredStreak: maxInspiredStreak,
                hasMoodTurnaround,
                varietyWeek,
                hasComeback,
                uniqueDays,
                allSeasons,
                consecutiveMonths: maxConsecutiveMonths
            };
        }

        async function checkAndUnlockAchievements() {
            const stats = await calculateAchievementStats();
            const unlocked = await getUnlockedAchievements();
            const newlyUnlocked = [];

            for (const achievement of achievements) {
                if (!unlocked.includes(achievement.id) && achievement.check(stats)) {
                    unlocked.push(achievement.id);
                    newlyUnlocked.push(achievement);
                }
            }

            if (newlyUnlocked.length > 0) {
                await saveUnlockedAchievements(unlocked);

                // Show notifications for new achievements
                for (const achievement of newlyUnlocked) {
                    await showAchievementNotification(achievement);
                }

                // Update badge
                await updateAchievementBadge();
            }
        }

        function showAchievementNotification(achievement) {
            return new Promise((resolve) => {
                const notification = document.createElement('div');
                notification.className = 'achievement-notification';
                notification.innerHTML = `
                    <div class="achievement-notification-icon">${achievement.icon}</div>
                    <div class="achievement-notification-title">Achievement Unlocked!</div>
                    <div class="achievement-notification-name">${achievement.name}</div>
                    <div class="achievement-notification-desc">${achievement.desc}</div>
                `;

                document.body.appendChild(notification);

                // Remove after 4 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(-50%) translateY(-20px)';
                    setTimeout(() => {
                        notification.remove();
                        resolve();
                    }, 300);
                }, 4000);
            });
        }

        async function updateAchievementBadge() {
            const unlocked = await getUnlockedAchievements();
            const badge = document.getElementById('achievementBadge');
            const newCount = unlocked.length;

            if (newCount > 0) {
                badge.textContent = newCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        async function openAchievementsModal() {
            const stats = await calculateAchievementStats();
            const unlocked = await getUnlockedAchievements();

            const categoriesContainer = document.getElementById('achievementsCategories');
            const unlockedCount = document.getElementById('unlockedCount');
            const totalCount = document.getElementById('totalCount');
            const progressFill = document.getElementById('achievementsProgressFill');

            // Count visible (unlocked or in-progress) achievements
            const visibleAchievements = achievements.filter(a => {
                const isUnlocked = unlocked.includes(a.id);
                const progressData = getAchievementProgressData(a, stats);
                return isUnlocked || (progressData && progressData.current > 0);
            });

            unlockedCount.textContent = unlocked.length;
            totalCount.textContent = visibleAchievements.length;
            const progressPercent = visibleAchievements.length > 0 ? (unlocked.length / visibleAchievements.length) * 100 : 0;
            progressFill.style.width = `${progressPercent}%`;

            // Group achievements by category
            const categories = {
                'entries': { title: 'üìù Diary Entries', icon: 'üìù' },
                'streaks': { title: 'üî• Streaks', icon: 'üî•' },
                'photos': { title: 'üì∏ Photos', icon: 'üì∏' },
                'moods': { title: 'üòä Moods & Emotions', icon: 'üòä' },
                'time': { title: '‚è∞ Time & Timing', icon: '‚è∞' },
                'writing': { title: '‚úçÔ∏è Writing', icon: '‚úçÔ∏è' },
                'special': { title: '‚≠ê Special', icon: '‚≠ê' },
                'fun': { title: 'üéÆ Fun & Discovery', icon: 'üéÆ' }
            };

            const groupedAchievements = {};
            achievements.forEach(achievement => {
                const category = achievement.category || 'special';
                if (!groupedAchievements[category]) {
                    groupedAchievements[category] = [];
                }
                groupedAchievements[category].push(achievement);
            });

            const categoriesHTML = Object.keys(groupedAchievements).map(categoryKey => {
                const categoryAchievements = groupedAchievements[categoryKey];
                const categoryInfo = categories[categoryKey] || { title: categoryKey, icon: 'üèÜ' };

                const unlockedInCategory = categoryAchievements.filter(a => unlocked.includes(a.id)).length;
                const visibleInCategory = categoryAchievements.filter(a => {
                    const isUnlocked = unlocked.includes(a.id);
                    const progressData = getAchievementProgressData(a, stats);
                    return isUnlocked || (progressData && progressData.current > 0);
                }).length;

                // Skip category if no achievements are visible
                if (visibleInCategory === 0) return '';

                const achievementCards = categoryAchievements.map(achievement => {
                    const isUnlocked = unlocked.includes(achievement.id);
                    const progressData = getAchievementProgressData(achievement, stats);

                    // Hide locked achievements with no progress
                    if (!isUnlocked && (!progressData || progressData.current === 0)) {
                        return '';
                    }

                    const cardClass = isUnlocked ? 'unlocked' : 'in-progress';
                    const progressPercent = progressData ? (progressData.current / progressData.total) * 100 : 0;

                    return `
                        <div class="achievement-card ${cardClass}">
                            <span class="achievement-icon">${achievement.icon}</span>
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-desc">${achievement.desc}</div>
                            ${!isUnlocked && progressData ? `
                                <div class="achievement-progress-container">
                                    <div class="achievement-progress-text">${progressData.current}/${progressData.total}</div>
                                    <div class="achievement-progress-bar-mini">
                                        <div class="achievement-progress-fill-mini" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).filter(card => card !== '').join('');

                if (!achievementCards) return '';

                return `
                    <div class="achievement-category">
                        <div class="achievement-category-title">
                            ${categoryInfo.title}
                            <span class="achievement-category-count">${unlockedInCategory}/${visibleInCategory}</span>
                        </div>
                        <div class="achievements-grid">
                            ${achievementCards}
                        </div>
                    </div>
                `;
            }).filter(cat => cat !== '').join('');

            // Show a message if no achievements are visible
            if (!categoriesHTML) {
                categoriesContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem 1rem; color: var(--color-text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üéØ</div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Start Your Journey!</div>
                        <div style="font-size: 0.9rem;">Create your first diary entry to unlock achievements</div>
                    </div>
                `;
            } else {
                categoriesContainer.innerHTML = categoriesHTML;
            }

            document.getElementById('achievementsModal').classList.add('active');
        }

        function getAchievementProgressData(achievement, stats) {
            // Return structured progress data { current, total }

            // Helper function to extract target from achievement ID
            function getTargetFromId(id) {
                // First try to extract numeric digits
                const numMatch = id.match(/\d+/);
                if (numMatch) {
                    return parseInt(numMatch[0]);
                }

                // Handle text-based numbers (check longest matches first to avoid partial matches)
                const textNumbers = [
                    ['threesixtyfive', 365],
                    ['twohundred', 200],
                    ['twentyfive', 25],
                    ['hundred', 100],
                    ['fifty', 50],
                    ['first', 1],
                    ['five', 5],
                    ['ten', 10]
                ];

                for (const [text, num] of textNumbers) {
                    if (id.includes(text)) {
                        return num;
                    }
                }

                return 0;
            }

            // Entry milestones
            if (achievement.id.includes('entries')) {
                const target = getTargetFromId(achievement.id);
                return { current: stats.totalEntries || 0, total: target };
            }
            // Streak achievements
            else if (achievement.id.includes('streak_')) {
                const target = getTargetFromId(achievement.id);
                return { current: stats.currentStreak || 0, total: target };
            }
            // Photo achievements
            else if (achievement.id.includes('photo') && !achievement.id.includes('double')) {
                const target = getTargetFromId(achievement.id);
                return { current: stats.totalPhotos || 0, total: target };
            }
            // Mood achievements
            else if (achievement.id === 'all_moods') {
                return { current: stats.uniqueMoods || 0, total: 24 };
            }
            else if (achievement.id === 'mood_rainbow_10') {
                return { current: stats.uniqueMoods || 0, total: 10 };
            }
            else if (achievement.id === 'grateful_streak_7') {
                return { current: stats.gratefulStreak || 0, total: 7 };
            }
            else if (achievement.id === 'happy_10') {
                return { current: stats.happyCount || 0, total: 10 };
            }
            else if (achievement.id === 'peaceful_10') {
                return { current: stats.peacefulCount || 0, total: 10 };
            }
            else if (achievement.id === 'positive_week') {
                return { current: Math.round(stats.positiveWeekPercent || 0), total: 70 };
            }
            // Reflection achievements
            else if (achievement.id === 'reflection_master') {
                return { current: stats.promptsAnswered || 0, total: 20 };
            }
            else if (achievement.id === 'reflection_legend') {
                return { current: stats.promptsAnswered || 0, total: 50 };
            }
            // Kids/Self moments
            else if (achievement.id === 'kids_moments') {
                return { current: stats.kidsMoments || 0, total: 30 };
            }
            else if (achievement.id === 'kids_moments_100') {
                return { current: stats.kidsMoments || 0, total: 100 };
            }
            else if (achievement.id === 'self_care') {
                return { current: stats.selfMoments || 0, total: 30 };
            }
            else if (achievement.id === 'self_care_100') {
                return { current: stats.selfMoments || 0, total: 100 };
            }
            // Time-based achievements
            else if (achievement.id === 'weekend_warrior_5') {
                return { current: stats.weekendEntries || 0, total: 5 };
            }
            else if (achievement.id === 'weekend_warrior_20') {
                return { current: stats.weekendEntries || 0, total: 20 };
            }
            else if (achievement.id === 'monday_motivation_5') {
                return { current: stats.mondayEntries || 0, total: 5 };
            }
            // Writing achievements
            else if (achievement.id === 'wordsmith_500') {
                return { current: stats.totalWords || 0, total: 500 };
            }
            else if (achievement.id === 'novelist_2000') {
                return { current: stats.totalWords || 0, total: 2000 };
            }
            else if (achievement.id === 'author_5000') {
                return { current: stats.totalWords || 0, total: 5000 };
            }
            else if (achievement.id === 'epic_writer_10000') {
                return { current: stats.totalWords || 0, total: 10000 };
            }
            // Special achievements
            else if (achievement.id === 'perfect_rating_10') {
                return { current: stats.perfectRatings || 0, total: 10 };
            }
            else if (achievement.id === 'inspired_streak_3') {
                return { current: stats.inspiredStreak || 0, total: 3 };
            }
            else if (achievement.id === 'energetic_5') {
                return { current: stats.energeticCount || 0, total: 5 };
            }
            else if (achievement.id === 'proud_moments_10') {
                return { current: stats.proudCount || 0, total: 10 };
            }
            else if (achievement.id === 'loved_feeling_10') {
                return { current: stats.lovedCount || 0, total: 10 };
            }
            else if (achievement.id === 'goose_dedication') {
                return { current: stats.uniqueDays || 0, total: 30 };
            }
            else if (achievement.id === 'monthly_regular') {
                return { current: stats.consecutiveMonths || 0, total: 3 };
            }
            // Binary achievements (no progress bar)
            else if (['balanced_month', 'early_bird', 'night_owl', 'lunch_break_writer', 'midnight_musing',
                      'golden_hour', 'long_entry', 'complete_entry', 'double_photo_day', 'triple_mood',
                      'mood_turnaround', 'comeback_kid', 'variety_week', 'triple_threat', 'rating_all_5',
                      'season_writer', 'hasTripleThreatEntry'].includes(achievement.id)) {
                return null;
            }
            return null;
        }

        function getAchievementProgress(achievement, stats) {
            // Return progress string for locked achievements (backward compatibility)
            const data = getAchievementProgressData(achievement, stats);
            if (!data) return '';

            const id = achievement.id;

            // Entry milestones
            if (id.includes('entries')) {
                return `${data.current}/${data.total} entries`;
            }
            // Streak achievements
            else if (id.includes('streak_')) {
                return `${data.current}/${data.total} days`;
            }
            // Photo achievements
            else if (id.includes('photo')) {
                return `${data.current}/${data.total} photos`;
            }
            // Mood achievements
            else if (id === 'all_moods' || id === 'mood_rainbow_10') {
                return `${data.current}/${data.total} moods`;
            }
            else if (id === 'grateful_streak_7' || id === 'inspired_streak_3') {
                return `${data.current}/${data.total} days`;
            }
            else if (id === 'happy_10' || id === 'peaceful_10') {
                return `${data.current}/${data.total} entries`;
            }
            else if (id === 'positive_week') {
                return `${data.current}%/${data.total}%`;
            }
            // Reflection achievements
            else if (id === 'reflection_master' || id === 'reflection_legend') {
                return `${data.current}/${data.total} prompts`;
            }
            // Kids/Self moments
            else if (id === 'kids_moments' || id === 'kids_moments_100' || id === 'self_care' || id === 'self_care_100') {
                return `${data.current}/${data.total} moments`;
            }
            // Time-based achievements
            else if (id === 'weekend_warrior_5' || id === 'weekend_warrior_20') {
                return `${data.current}/${data.total} weekends`;
            }
            else if (id === 'monday_motivation_5') {
                return `${data.current}/${data.total} Mondays`;
            }
            // Writing achievements
            else if (id.includes('wordsmith') || id.includes('novelist') || id.includes('author') || id.includes('epic_writer')) {
                return `${data.current}/${data.total} words`;
            }
            // Special achievements
            else if (id === 'perfect_rating_10') {
                return `${data.current}/${data.total} perfect days`;
            }
            else if (id === 'energetic_5' || id === 'proud_moments_10' || id === 'loved_feeling_10') {
                return `${data.current}/${data.total} entries`;
            }
            else if (id === 'goose_dedication') {
                return `${data.current}/${data.total} days`;
            }
            else if (id === 'monthly_regular') {
                return `${data.current}/${data.total} months`;
            }
            return '';
        }

        function showPhotoModal(photoSrc) {
            document.getElementById('modalPhoto').src = photoSrc;
            document.getElementById('photoModal').classList.add('active');
        }
    </script>
    </body>
</html>